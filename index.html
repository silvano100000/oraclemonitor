<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- CDN do Chart.js corrigido para uma versão específica -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Moment.js for Chart.js date adapter -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    <!-- Interact.js CDN para arrastar e redimensionar -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.11/dist/interact.min.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            /* Adicionado para permitir o redimensionamento e arrastar */
            touch-action: none; /* Desabilita o comportamento padrão de toque do navegador */
            user-select: none; /* Desabilita a seleção de texto durante o arraste */
            position: relative; /* Necessário para transform */
            box-sizing: border-box; /* Garante que padding e border sejam incluídos na largura/altura */
        }
        .status-normal { background-color: #d1fae5; color: #065f46; } /* green-100, green-800 */
        .status-warning { background-color: #fff3cd; color: #856404; } /* yellow-100, yellow-800 */
        .status-critical { background-color: #fde6e6; color: #991b1b; } /* red-100, red-800 */
        /* Adicionar estilos para os status de conta */
        .status-open { background-color: #d1fae5; color: #065f46; } /* green-100, green-800 */
        .status-locked { background-color: #fde6e6; color: #991b1b; } /* red-100, red-800 */
        .status-expired { background-color: #fff3cd; color: #856404; } /* yellow-100, yellow-800 */
        .status-expired-grace { background-color: #fff3cd; color: #856404; } /* yellow-100, yellow-800 */
        .status-unknown { background-color: #e2e8f0; color: #4a5568; } /* gray-200, gray-700 */
        /* NEW: Status for dropping schema */
        .status-dropping { background-color: #e0f2fe; color: #0369a1; } /* light blue for dropping */
        /* NEW: Status for backup in progress */
        .status-backup-em-andamento { background-color: #bfdbfe; color: #1e40af; } /* blue-200, blue-800 */


        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
            width: 100%;
        }
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-size: 1.2rem;
            color: #333;
            display: none; /* Hidden by default */
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pop-up Message Box */
        #popup-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            z-index: 10001; /* Above all other modals */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            min-width: 250px;
            max-width: 90%;
        }
        #popup-message-box.show {
            opacity: 1;
        }
        #popup-message-box.error {
            background-color: #fef2f2; /* red-100 */
            color: #ef4444; /* red-500 */
            border: 1px solid #fca5a5; /* red-300 */
        }
        #popup-message-box.success {
            background-color: #ecfdf5; /* green-100 */
            color: #10b981; /* green-500 */
            border: 1px solid #6ee7b7; /* green-300 */
        }

        /* Table Action Buttons */
        .table-action-button {
            background-color: #4c51bf; /* indigo-700 */
            color: white;
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s ease;
        }
        .table-action-button:hover {
            background-color: #3d4899; /* indigo-800 */
        }
        .table-action-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        /* Sort icons */
        th .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }
        th.sortable {
            cursor: pointer;
        }
        th.sortable:hover {
            background-color: #4045a8; /* Slightly darker indigo on hover */
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-table, #printable-table * {
                visibility: visible;
            }
            #printable-table {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="p-6">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <span>A carregar dados do Oracle...</span>
    </div>

    <!-- Pop-up Message Box: Usado para exibir mensagens de sucesso ou erro após uma ação. -->
    <div id="popup-message-box" class="hidden">
        <span id="popup-message-text"></span>
    </div>

    <div id="main-content-wrapper" class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Monitor de Espaço e Saúde Oracle</h1>

        <!-- Dropdown para seleção de TNS -->
        <div class="mb-6 flex justify-center">
            <label for="tns-select" class="block text-lg font-medium text-gray-700 mr-3 self-center">Selecionar Banco de Dados (TNS):</label>
            <select id="tns-select" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                <!-- Opções serão carregadas via JS -->
            </select>
        </div>

        <!-- Seção de Espaço da Base de Dados -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="card text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Espaço Total (GB)</h2>
                <p id="total-gb" class="text-3xl font-bold text-blue-600">Carregando...</p>
            </div>
            <div class="card text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Espaço Livre (GB)</h2>
                <p id="free-gb" class="text-3xl font-bold text-green-600">Carregando...</p>
            </div>
            <div class="card text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Espaço Usado (GB)</h2>
                <p id="used-gb" class="text-3xl font-bold text-red-600">Carregando...</p>
            </div>
            <div class="card text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Uso Total (%)</h2>
                <p id="used-percent" class="text-3xl font-bold text-purple-600">Carregando...</p>
            </div>
        </div>

        <!-- Seção de Tabelas (Tablespaces e Schemas) -->
        <!-- Alterado para grid-cols-1 para empilhar verticalmente -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- Tablespace Space -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Espaço por Tablespace</h2>
                <div class="flex justify-end mb-4">
                    <button onclick="printTableReport('tablespace-table', 'Relatório de Espaço por Tablespace')" class="table-action-button bg-gray-600 hover:bg-gray-700 p-2 rounded-full">
                        <i class="fas fa-print text-lg"></i>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="tablespace-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortTablespaceTable('name')">Nome <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortTablespaceTable('total_gb')">Total (GB) <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortTablespaceTable('free_gb')">Livre (GB) <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortTablespaceTable('used_gb')">Usado (GB) <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortTablespaceTable('used_percent')">Uso (%) <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortTablespaceTable('status')">Status <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tablespace-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dados serão carregados via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Schema Space -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Espaço por Schema (Utilizador)</h2>
                <div class="mb-4 flex justify-between items-center"> <!-- Novo contêiner para o campo de pesquisa -->
                    <label for="schema-search" class="block text-sm font-medium text-gray-700 mr-2">Pesquisar Schema:</label>
                    <input type="text" id="schema-search" placeholder="Digite o nome do schema..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <button onclick="printTableReport('schema-table', 'Relatório de Espaço por Schema')" class="table-action-button bg-gray-600 hover:bg-gray-700 ml-4 p-2 rounded-full">
                        <i class="fas fa-print text-lg"></i>
                    </button>
                </div>
                <!-- Removido max-h-96 para permitir expansão vertical -->
                <div class="overflow-x-auto overflow-y-auto">
                    <table id="schema-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortSchemaTable('name')">Nome do Schema <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortSchemaTable('used_gb')">Usado (GB) <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" onclick="sortSchemaTable('account_status')">Status da Conta <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="schema-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dados serão carregados via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Seção de Sessões Ativas (Condicional) -->
        <div id="active-sessions-section" class="card" style="display: none;">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Sessões Ativas</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Total Sessions -->
                <div id="session-status-box" class="bg-blue-50 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">Total de Sessões: <span id="total-sessions" class="font-bold">0</span></h3>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Sumário de Status:</h4>
                    <ul id="session-status-summary" class="list-disc list-inside">
                        <!-- Data will be loaded via JS -->
                    </ul>
                </div>

                <!-- Top Users -->
                <div id="top-users-box" class="bg-purple-50 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-purple-800 mb-2">Top 5 Utilizadores por Sessões</h3>
                    <ul id="top-users-list" class="list-disc list-inside">
                        <!-- Data will be loaded via JS -->
                    </ul>
                </div>

                <!-- Top Programs -->
                <div id="top-programs-box" class="bg-yellow-50 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-2">Top 5 Programas por Sessões</h3>
                    <ul id="top-programs-list" class="list-disc list-inside">
                        <!-- Data will be loaded via JS -->
                    </ul>
                </div>

                <!-- Waiting Sessions -->
                <div id="waiting-sessions-box" class="bg-orange-50 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-orange-800 mb-2">Sessões em Espera (Top 5 Eventos)</h3>
                    <ul id="waiting-sessions-list" class="list-disc list-inside">
                        <!-- Data will be loaded via JS -->
                    </ul>
                </div>

                <!-- Blocked Sessions -->
                <div id="blocked-sessions-box" class="bg-red-50 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-red-800 mb-2">Sessões Bloqueadas</h3>
                    <ul id="blocked-sessions-list" class="list-disc list-inside">
                        <!-- Data will be loaded via JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Seção de Health Check da Instância (Condicional) -->
        <div id="instance-health-section" class="card mt-6" style="display: none;">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Health Check da Instância Oracle</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-green-50 p-4 rounded-lg shadow">
                    <p class="text-lg font-medium text-gray-700">Nome da Instância: <span id="instance-name" class="font-bold">Carregando...</span></p>
                    <p class="text-lg font-medium text-gray-700">Status: <span id="instance-status" class="font-bold">Carregando...</span></p>
                    <p class="text-lg font-medium text-gray-700">Host: <span id="host-name" class="font-bold">Carregando...</span></p>
                    <p class="text-lg font-medium text-gray-700">Versão: <span id="instance-version" class="font-bold">Carregando...</span></p>
                    <p class="text-lg font-medium text-gray-700">Tempo de Inicialização: <span id="startup-time" class="font-bold">Carregando...</span></p>
                    <p class="text-lg font-medium text-gray-700">TNS Conectado: <span id="connected-tns" class="font-bold">Carregando...</span></p>
                </div>
            </div>
        </div>

        <!-- NOVO: Seção de Histórico Combinado de Tablespaces e Schemas -->
        <div id="combined-history-section" class="card mt-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Histórico de Uso Geral (Tablespaces % / Schemas GB)</h2>
            <div class="flex items-center justify-between space-x-4 mb-4">
                <div class="flex items-center space-x-4">
                    <div>
                        <label for="combined-history-start-date" class="block text-sm font-medium text-gray-700">Data Início:</label>
                        <input type="date" id="combined-history-start-date" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="combined-history-end-date" class="block text-sm font-medium text-gray-700">Data Fim:</label>
                        <input type="date" id="combined-history-end-date" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <!-- Novo seletor de tipo de gráfico -->
                    <div>
                        <label for="combined-history-chart-type" class="block text-sm font-medium text-gray-700">Tipo de Gráfico:</label>
                        <select id="combined-history-chart-type" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="line">Linha</option>
                            <option value="bar">Barra</option>
                            <option value="scatter">Dispersão</option>
                        </select>
                    </div>
                    <!-- Novo seletor de visualização -->
                    <div>
                        <label for="combined-history-view-filter" class="block text-sm font-medium text-gray-700">Visualizar:</label>
                        <select id="combined-history-view-filter" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="all">Todos</option>
                            <option value="tablespaces">Tablespaces</option>
                            <option value="schemas">Schemas</option>
                        </select>
                    </div>
                    <button id="combined-history-filter-button" class="mt-5 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Aplicar Filtro
                    </button>
                </div>
                <button onclick="printChart('combined-history-chart', 'Histórico de Uso Geral')" class="table-action-button bg-gray-600 hover:bg-gray-700 p-2 rounded-full mt-5">
                    <i class="fas fa-print text-lg"></i>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="combined-history-chart"></canvas>
            </div>
        </div>

        <!-- Modal de Detalhes do Tablespace -->
        <div id="tablespace-details-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('tablespace-details-modal')">&times;</span>
                <h2 id="tablespace-details-title" class="text-2xl font-bold mb-4">Detalhes do Tablespace: </h2>
                
                <!-- Gráfico de Histórico do Tablespace -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Histórico de Uso (%)</h3>
                    <div class="flex items-center space-x-4 mb-4">
                        <div>
                            <label for="tablespace-history-start-date" class="block text-sm font-medium text-gray-700">Data Início:</label>
                            <input type="date" id="tablespace-history-start-date" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="tablespace-history-end-date" class="block text-sm font-medium text-gray-700">Data Fim:</label>
                            <input type="date" id="tablespace-history-end-date" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <!-- Novo seletor de tipo de gráfico para o histórico do tablespace -->
                        <div>
                            <label for="tablespace-history-chart-type" class="block text-sm font-medium text-gray-700">Tipo de Gráfico:</label>
                            <select id="tablespace-history-chart-type" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="line">Linha</option>
                                <option value="bar">Barra</option>
                                <option value="scatter">Dispersão</option>
                            </select>
                        </div>
                        <button onclick="applyTablespaceHistoryFilter()" class="mt-5 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Aplicar Filtro
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="tablespace-history-chart"></canvas>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-2">Ficheiros de Dados</h3>
                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Ficheiro</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tamanho (GB)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tamanho Máx (GB)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Autoextensível</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="datafiles-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded via JS -->
                        </tbody>
                    </table>
                    <p id="no-datafiles-message" class="text-gray-500 text-sm mt-2 hidden">Nenhum ficheiro de dados encontrado para este tablespace.</p>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-2">Top 10 Objetos por Tamanho</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proprietário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Segmento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tamanho (MB)</th>
                            </tr>
                        </thead>
                        <tbody id="tablespace-top-objects-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded via JS -->
                        </tbody>
                    </table>
                    <p id="no-tablespace-objects-message" class="text-gray-500 text-sm mt-2 hidden">Nenhum objeto encontrado neste tablespace.</p>
                </div>

                <!-- Formulário para Adicionar Datafile -->
                <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Adicionar Novo Datafile</h3>
                    <form id="add-datafile-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-datafile-name" class="block text-sm font-medium text-gray-700">Nome do Ficheiro:</label>
                            <input type="text" id="new-datafile-name" name="file_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                        </div>
                        <div>
                            <label for="new-datafile-size" class="block text-sm font-medium text-gray-700">Tamanho:</label>
                            <div class="flex items-center mt-1">
                                <input type="number" id="new-datafile-size" name="size_value" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                                <select id="new-datafile-size-unit" name="size_unit" class="ml-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <option value="MB">MB</option>
                                    <option value="GB">GB</option>
                                </select>
                            </div>
                        </div>
                        <div class="md:col-span-2 flex items-center">
                            <input type="checkbox" id="new-datafile-autoextend" name="autoextend" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="new-datafile-autoextend" class="ml-2 block text-sm text-gray-900">Autoextensível</label>
                        </div>
                        <div id="autoextend-options" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                            <div>
                                <label for="new-datafile-next-size" class="block text-sm font-medium text-gray-700">Próximo Tamanho:</label>
                                <div class="flex items-center mt-1">
                                    <input type="number" id="new-datafile-next-size" name="next_size_value" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <select id="new-datafile-next-size-unit" name="next_size_unit" class="ml-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                        <option value="MB">MB</option>
                                        <option value="GB">GB</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="new-datafile-max-size" class="block text-sm font-medium text-gray-700">Tamanho Máx:</label>
                                <div class="flex items-center mt-1">
                                    <input type="number" id="new-datafile-max-size" name="max_size_value" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <select id="new-datafile-max-size-unit" name="max_size_unit" class="ml-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                        <option value="MB">MB</option>
                                        <option value="GB">GB</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Adicionar Datafile
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de Redimensionar Datafile -->
        <div id="resize-datafile-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('resize-datafile-modal')">&times;</span>
                <h2 class="text-2xl font-bold mb-4">Redimensionar Datafile: <span id="resize-datafile-name-display"></span></h2>
                
                <form id="resize-datafile-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="current-resize-datafile-name">
                    <div>
                        <label for="new-resize-size" class="block text-sm font-medium text-gray-700">Novo Tamanho:</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="new-resize-size" name="new_size_value" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <select id="new-resize-size-unit" name="new_size_unit" class="ml-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="MB">MB</option>
                                <option value="GB">GB</option>
                            </select>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Deixe em branco para apenas configurar autoextend.</p>
                    </div>
                    <div class="flex items-center md:col-span-2">
                        <input type="checkbox" id="resize-datafile-autoextend" name="autoextend" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="resize-datafile-autoextend" class="ml-2 block text-sm text-gray-900">Autoextensível</label>
                    </div>
                    <div id="resize-autoextend-options" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <div>
                            <label for="resize-datafile-next-size" class="block text-sm font-medium text-gray-700">Próximo Tamanho:</label>
                            <div class="flex items-center mt-1">
                                <input type="number" id="resize-datafile-next-size" name="next_size_value" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-ring-indigo-200 focus:ring-opacity-50">
                                <select id="resize-datafile-next-size-unit" name="next_size_unit" class="ml-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <option value="MB">MB</option>
                                    <option value="GB">GB</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="resize-datafile-max-size" class="block text-sm font-medium text-gray-700">Tamanho Máx:</label>
                            <div class="flex items-center mt-1">
                                <input type="number" id="resize-datafile-max-size" name="max_size_value" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <select id="resize-datafile-max-size-unit" name="max_size_unit" class="ml-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <option value="MB">MB</option>
                                    <option value="GB">GB</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Redimensionar Datafile
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Detalhes do Schema -->
        <div id="schema-details-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('schema-details-modal')">&times;</span>
                <h2 id="schema-details-title" class="text-2xl font-bold mb-4">Detalhes do Schema: </h2>

                <div class="mb-4">
                    <p class="text-lg font-medium text-gray-700">Data de Criação: <span id="schema-creation-date" class="font-bold">Carregando...</span></p>
                    <p class="text-lg font-medium text-gray-700">Status da Conta: <span id="schema-account-status" class="font-bold">Carregando...</span></p>
                    <!-- Tablespace Padrão -->
                    <p class="text-lg font-medium text-gray-700">Tablespace Padrão: <span id="schema-default-tablespace" class="font-bold">Carregando...</span></p>
                </div>

                <!-- Formulário para Alterar Senha do Schema -->
                <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Alterar Palavra-passe do Schema</h3>
                    <form id="change-schema-password-form">
                        <input type="hidden" id="change-password-schema-name">
                        <div class="mb-4">
                            <label for="new-schema-password" class="block text-sm font-medium text-gray-700">Nova Palavra-passe:</label>
                            <input type="password" id="new-schema-password" name="new_password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                        </div>
                        <div>
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Alterar Palavra-passe
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Formulário para Alterar Tablespace Padrão do Schema -->
                <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Alterar Tablespace Padrão</h3>
                    <form id="change-default-tablespace-form">
                        <input type="hidden" id="change-default-tablespace-schema-name">
                        <div class="mb-4">
                            <label for="new-default-tablespace-select" class="block text-sm font-medium text-gray-700">Novo Tablespace Padrão:</label>
                            <select id="new-default-tablespace-select" name="new_default_tablespace" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" required>
                                <!-- Options populated dynamically by JS -->
                            </select>
                        </div>
                        <div>
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Alterar Tablespace Padrão
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Gerenciamento do Usuário -->
                <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Gerenciamento do Usuário</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4"> <!-- Changed to 4 columns -->
                        <button onclick="confirmDropSchema(currentSchemaForDetails)" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Dropar Usuário
                        </button>
                        <button id="lock-schema-button" onclick="confirmLockSchema(currentSchemaForDetails)" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                            Bloquear Usuário
                        </button>
                        <button id="unlock-schema-button" onclick="confirmUnlockSchema(currentSchemaForDetails)" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Desbloquear Usuário
                        </button>
                        <!-- NEW: Data Pump Backup Button -->
                        <button onclick="openBackupModal(currentSchemaForDetails)" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Backup Datapump
                        </button>
                    </div>
                </div>

                <!-- Grants do Schema (Roles) -->
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Roles Concedidas</h3>
                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Administrável</th>
                            </tr>
                        </thead>
                        <tbody id="schema-role-grants-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded via JS -->
                        </tbody>
                    </table>
                    <p id="no-schema-role-grants-message" class="text-gray-500 text-sm mt-2 hidden">Nenhuma role encontrada para este schema.</p>
                </div>

                <!-- Grants do Schema (System Privileges) -->
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Privilégios de Sistema Concedidos</h3>
                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Privilégio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Administrável</th>
                            </tr>
                        </thead>
                        <tbody id="schema-sys-grants-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded via JS -->
                        </tbody>
                    </table>
                    <p id="no-schema-sys-grants-message" class="text-gray-500 text-sm mt-2 hidden">Nenhum privilégio de sistema encontrado para este schema.</p>
                </div>

                <!-- Grants do Schema (Object Privileges) -->
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Privilégios de Objeto Concedidos</h3>
                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Objeto Proprietário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Objeto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Privilégio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concedível</th>
                            </tr>
                        </thead>
                        <tbody id="schema-tab-grants-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded via JS -->
                        </tbody>
                    </table>
                    <p id="no-schema-tab-grants-message" class="text-gray-500 text-sm mt-2 hidden">Nenhum privilégio de objeto encontrado para este schema.</p>
                </div>

                <!-- Formulário para Adicionar Grant -->
                <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Adicionar Grant ao Schema</h3>
                    <form id="add-schema-grant-form">
                        <input type="hidden" id="add-grant-schema-name">
                        <div class="mb-4">
                            <label for="new-grant-name" class="block text-sm font-medium text-gray-700">Nome do Grant (Role/Privilégio):</label>
                            <input type="text" id="new-grant-name" name="grant_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                        </div>
                        <div class="mb-4 flex items-center">
                            <input type="checkbox" id="with-admin-option" name="with_admin_option" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="with-admin-option" class="ml-2 block text-sm text-gray-900">WITH ADMIN OPTION</label>
                        </div>
                        <div>
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Adicionar Grant
                            </button>
                        </div>
                    </form>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-2">Top 10 Objetos por Tamanho</h3>
                <!-- Filtro por tipo de objeto -->
                <div class="mb-4 flex items-center">
                    <label for="schema-object-type-filter" class="block text-sm font-medium text-gray-700 mr-2">Filtrar por Tipo:</label>
                    <select id="schema-object-type-filter" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:ring-indigo-200 focus:ring-opacity-50 sm:text-sm rounded-md shadow-sm">
                        <option value="ALL">Todos os Tipos</option>
                        <option value="TABLE">TABLE</option>
                        <option value="INDEX">INDEX</option>
                        <option value="LOBSEGMENT">LOBSEGMENT</option>
                        <option value="CLUSTER">CLUSTER</option>
                        <option value="PARTITION">PARTITION</option>
                        <option value="SUBPARTITION">SUBPARTITION</option>
                        <!-- Adicione mais tipos conforme necessário -->
                    </select>
                </div>
                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Segmento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tamanho (MB)</th>
                            </tr>
                        </thead>
                        <tbody id="schema-top-objects-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded via JS -->
                        </tbody>
                    </table>
                    <p id="no-schema-top-objects-message" class="text-gray-500 text-sm mt-2 hidden">Nenhum objeto (tabela) encontrado neste schema.</p>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-2">Contagem de Objetos por Tipo</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo de Objeto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contagem</th>
                            </tr>
                        </thead>
                        <tbody id="schema-object-counts-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded via JS -->
                        </tbody>
                    </table>
                    <p id="no-schema-object-counts-message" class="text-gray-500 text-sm mt-2 hidden">Nenhum tipo de objeto encontrado neste schema.</p>
                </div>
                <div class="mt-6 text-center">
                    <button onclick="openSchemaHistoryModal(document.getElementById('schema-details-title').textContent.replace('Detalhes do Schema: ', ''))" class="table-action-button bg-blue-600 hover:bg-blue-700">
                        Ver Histórico do Schema
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW: Modal de Backup Datapump -->
        <div id="backup-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('backup-modal')">&times;</span>
                <h2 class="text-2xl font-bold mb-4">Backup Datapump para Schema: <span id="backup-schema-name-display"></span></h2>
                
                <form id="backup-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="backup-schema-name">
                    <div>
                        <label for="backup-directory" class="block text-sm font-medium text-gray-700">Diretório Datapump:</label>
                        <select id="backup-directory" name="directory" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" required>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="backup-dmp-file" class="block text-sm font-medium text-gray-700">Nome do Arquivo DMP:</label>
                        <input type="text" id="backup-dmp-file" name="dmp_file" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="backup-log-file" class="block text-sm font-medium text-gray-700">Nome do Arquivo LOG:</label>
                        <input type="text" id="backup-log-file" name="log_file" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-ring-indigo-200 focus:ring-opacity-50" required>
                    </div>
                    <div class="md:col-span-2 mt-4">
                        <button type="submit" id="start-backup-button" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Iniciar Backup
                        </button>
                    </div>
                </form>

                <div id="backup-status-area" class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Status do Backup</h3>
                    <p class="text-lg font-medium text-gray-700">Status: <span id="backup-current-status" class="font-bold"></span></p>
                    <!-- REMOVED: Progress Bar and Estimated Time -->
                    <h4 class="text-lg font-semibold text-gray-800 mt-4 mb-2">Log de Saída:</h4>
                    <pre id="backup-log-output" class="bg-gray-100 p-3 rounded-md text-xs overflow-auto max-h-48"></pre>
                </div>
            </div>
        </div>

        <!-- Modal de Histórico do Schema -->
        <div id="schema-history-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('schema-history-modal')">&times;</span>
                <h2 id="schema-history-title" class="text-2xl font-bold mb-4">Histórico do Schema: </h2>

                <!-- Gráfico de Histórico de Uso do Schema -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Histórico de Uso (GB)</h3>
                    <div class="flex items-center space-x-4 mb-4">
                        <div>
                            <label for="schema-history-start-date" class="block text-sm font-medium text-gray-700">Data Início:</label>
                            <input type="date" id="schema-history-start-date" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="schema-history-end-date" class="block text-sm font-medium text-gray-700">Data Fim:</label>
                            <input type="date" id="schema-history-end-date" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <!-- Novo seletor de tipo de gráfico para o histórico do schema -->
                        <div>
                            <label for="schema-history-chart-type" class="block text-sm font-medium text-gray-700">Tipo de Gráfico:</label>
                            <select id="schema-history-chart-type" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="line">Linha</option>
                                <option value="bar">Barra</option>
                                <option value="scatter">Dispersão</option>
                            </select>
                        </div>
                        <button onclick="applySchemaHistoryFilter()" class="mt-5 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Aplicar Filtro
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="schema-history-chart-new"></canvas> <!-- ID diferente para o novo gráfico -->
                    </div>
                </div>

                <!-- Log de Alterações do Schema (Placeholder) -->
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Log de Alterações do Schema</h3>
                <div class="flex items-center space-x-4 mb-4">
                    <div>
                        <label for="schema-log-start-date" class="block text-sm font-medium text-gray-700">Data Início:</label>
                        <input type="date" id="schema-log-start-date" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="schema-log-end-date" class="block text-sm font-medium text-gray-700">Data Fim:</label>
                        <input type="date" id="schema-log-end-date" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <button onclick="applySchemaLogFilter()" class="mt-5 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Aplicar Filtro
                        </button>
                </div>
                <div class="overflow-x-auto max-h-64 overflow-y-auto p-4 bg-gray-100 rounded-md">
                    <ul id="schema-change-log-body" class="list-disc list-inside text-sm text-gray-700">
                        <li>Carregando log de alterações...</li>
                        <!-- Dados de log serão carregados via JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Modal de Criação de Utilizador -->
        <div id="create-user-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('create-user-modal')">&times;</span>
                <h2 class="text-2xl font-bold mb-4">Criar Novo Utilizador Oracle</h2>
                
                <form id="create-user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="new-username" class="block text-sm font-medium text-gray-700">Nome de Utilizador:</label>
                        <input type="text" id="new-username" name="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Palavra-passe:</label>
                        <input type="password" id="new-password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="default-tablespace" class="block text-sm font-medium text-gray-700">Tablespace Padrão:</label>
                        <select id="default-tablespace" name="default_tablespace" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" required>
                            <!-- Options populated dynamically by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="temporary-tablespace" class="block text-sm font-medium text-gray-700">Tablespace Temporário (Opcional):</label>
                        <select id="temporary-tablespace" name="temporary_tablespace" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <!-- Options populated dynamically by JS -->
                        </select>
                    </div>
                    <div class="md:col-span-2 flex items-center">
                        <input type="checkbox" id="grant-dba" name="grant_dba" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="grant-dba" class="ml-2 block text-sm text-gray-900">Conceder privilégio DBA</label>
                    </div>
                    <div class="md:col-span-2 flex items-center">
                        <input type="checkbox" id="grant-create-session" name="grant_create_session" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                        <label for="grant-create-session" class="ml-2 block text-sm text-gray-900">Conceder privilégio CREATE SESSION</label>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Criar Utilizador
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Password Prompt Modal: Exibido para ações que requerem autenticação administrativa. -->
        <div id="admin-password-prompt-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('admin-password-prompt-modal')">&times;</span>
                <h2 class="text-2xl font-bold mb-4">Confirmação Administrativa</h2>
                
                <form id="admin-password-form">
                    <div class="mb-4">
                        <label for="admin-password-input" class="block text-sm font-medium text-gray-700">Senha Administrativa:</label>
                        <input type="password" id="admin-password-input" name="admin_password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Confirmar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal: Usado para confirmações antes de ações críticas. -->
        <div id="confirmation-modal" class="modal">
            <div class="modal-content text-center">
                <span class="close-button" onclick="closeModal('confirmation-modal')">&times;</span>
                <h2 id="confirmation-title" class="text-2xl font-bold mb-4">Confirmação</h2>
                <p id="confirmation-message" class="text-lg text-gray-700 mb-6">Tem certeza que deseja realizar esta ação?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-action-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Confirmar
                    </button>
                    <button onclick="closeModal('confirmation-modal')" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer com a versão -->
    <footer class="fixed bottom-2 right-2 text-xs text-gray-400 opacity-70">
        Versão <span id="app-version-display">Carregando...</span>
    </footer>

    <script>
        // Chart instances
        let tablespaceHistoryChartInstance = null;
        let schemaHistoryChartInstance = null;
        let combinedHistoryChartInstance = null; // NEW: Combined history chart instance

        // Data storage
        let tnsList = [];
        let selectedTNS = '';
        let tablespaceData = [];
        let schemaData = [];
        let activeSessionsData = null;
        let instanceHealthData = null;

        // Global state for modals
        let currentTablespaceForDatafile = '';
        let currentDatafileToResize = '';
        let currentSchemaForDetails = '';
        let currentSchemaForBackup = ''; // NEW: To store schema name for backup modal
        let backupPollingInterval = null; // NEW: To store the interval ID for backup status polling

        // nextAdminAction now stores the function and its arguments, including the admin password
        let nextAdminAction = null; 
        // nextConfirmationAction stores the function and its arguments for the generic confirmation modal
        let nextConfirmationAction = null;

        // NEW: Objeto para armazenar os schemas que estão em processo de drop
        // Estrutura: { 'schemaName': { rowElement: HTMLElement, pollingInterval: number } }
        let droppingSchemas = {};
        const POLLING_INTERVAL_MS = 3000; // Poll every 3 seconds for drop status

        // UI Configuration (fetched from backend)
        let uiConfig = {
            enable_active_sessions: true,
            enable_instance_health: true,
            enable_session_status_box: true,
            enable_top_users_box: true,
            enable_top_programs_box: true,
            enable_waiting_sessions_box: true,
            enable_blocked_sessions_box: true
        };

        // NEW: Global sorting state for schema table
        let currentSchemaSortColumn = 'name'; // Default sort column
        let currentSchemaSortDirection = 'asc'; // Default sort direction

        // NEW: Global sorting state for tablespace table
        let currentTablespaceSortColumn = 'name'; // Default sort column
        let currentTablespaceSortDirection = 'asc'; // Default sort direction

        // Base API URL - IMPORTANT: Adjust if your Flask server runs on
        const BASE_API_URL = 'https://127.0.0.1:5000/api';

        // --- Utility Functions ---
        function toggleLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
                console.log(`Frontend: Overlay de carregamento ${show ? 'mostrado' : 'ocultado'}.`);
            }
        }

        let popupTimeout; // To store the timeout ID for auto-hiding the pop-up

        // Pop-up message box (for all messages)
        // Esta função é responsável por exibir as mensagens de sucesso/erro.
        function showPopupMessage(type, text, duration = 2000) { // Default duration 2 seconds
            const popupBox = document.getElementById('popup-message-box');
            const popupText = document.getElementById('popup-message-text');

            // Clear any existing timeout
            if (popupTimeout) {
                clearTimeout(popupTimeout);
            }

            // Remove all relevant classes to reset state
            popupBox.classList.remove('error', 'success', 'show'); // Keep 'hidden' removal separate or remove it entirely
            
            // Add type class
            popupBox.classList.add(type); // 'error' ou 'success'
            popupText.textContent = text;

            // Explicitly set display to flex for centering, and remove 'hidden'
            popupBox.style.display = 'flex'; // Change from 'block' to 'flex' as it's a centered overlay
            popupBox.classList.remove('hidden'); // Ensure hidden is removed if it was there

            // Force reflow
            void popupBox.offsetWidth;

            // Start fade-in animation
            popupBox.classList.add('show');

            console.log(`Frontend: Pop-up Mensagem (${type}): ${text}`);

            // Set timeout to hide the message
            popupTimeout = setTimeout(() => {
                popupBox.classList.remove('show'); // Start fade-out animation
                popupBox.addEventListener('transitionend', function handler() {
                    popupBox.style.display = 'none'; // Explicitly hide after transition
                    popupBox.classList.add('hidden'); // Add hidden back for consistency / future use
                    popupBox.removeEventListener('transitionend', handler);
                    console.log("Frontend: Pop-up Mensagem ocultada.");
                }, { once: true });
            }, duration);
        }

        function clearPopupMessage() {
            const popupBox = document.getElementById('popup-message-box');
            if (popupTimeout) {
                clearTimeout(popupTimeout);
                popupTimeout = null;
            }
            popupBox.classList.remove('show'); // Remove show class to start fade out
            // Explicitly hide it immediately if clear is called before timeout
            popupBox.style.display = 'none';
            popupBox.classList.add('hidden');
            console.log("Frontend: Pop-up Mensagens limpas.");
        }

        // Global message box (now redirects to popup)
        function showGlobalMessage(type, text) {
            showPopupMessage(type, text);
        }

        function clearGlobalMessages() {
            clearPopupMessage(); // Global messages are now pop-ups
        }

        // Modal specific message box (now redirects to popup)
        function showModalMessage(modalId, type, text) {
            showPopupMessage(type, text);
        }

        function clearModalMessage(modalId) {
            // Modal messages are now pop-ups, so clearing is handled by clearPopupMessage
            // No specific action needed here if the pop-up auto-hides.
            // However, if a modal is closed, we might want to ensure any active popup is cleared.
            clearPopupMessage();
        }

        // Generic modal open/close
        function openModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.style.display = 'flex';
                console.log(`Frontend: Modal '${modalId}' aberto. Display set to flex.`);
                clearPopupMessage(); // Clear any active pop-up when a modal opens
            } else {
                console.error(`Frontend: Erro: Modal com ID '${modalId}' não encontrado.`);
            }
        }

        function closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.style.display = 'none';
                console.log(`Frontend: Modal '${modalId}' fechado. Display set to none.`);
                // Destroy chart instances if the modal contains them
                if (modalId === 'tablespace-details-modal' && tablespaceHistoryChartInstance) {
                    tablespaceHistoryChartInstance.destroy();
                    tablespaceHistoryChartInstance = null;
                }
                if (modalId === 'schema-history-modal' && schemaHistoryChartInstance) {
                    schemaHistoryChartInstance.destroy();
                    schemaHistoryChartInstance = null;
                }
                if (modalId === 'combined-history-section' && combinedHistoryChartInstance) { // NEW: Destroy combined chart
                    combinedHistoryChartInstance.destroy();
                    combinedHistoryChartInstance = null;
                }
                // NEW: Stop backup polling if closing backup modal
                if (modalId === 'backup-modal' && backupPollingInterval) {
                    clearInterval(backupPollingInterval);
                    backupPollingInterval = null;
                    console.log("Frontend: Parado o polling de status de backup.");
                }
                // No need to clear adminPasswordValidated here, as it's passed directly to the action function
                clearPopupMessage(); // Clear any active pop-up when a modal closes
            } else {
                console.error(`Frontend: Erro: Modal com ID '${modalId}' não encontrado para fechar.`);
            }
        }

        // --- API Fetching Functions ---
        async function fetchData(endpoint, params = {}) {
            clearPopupMessage(); // Clear any active pop-up for new data fetch
            toggleLoading(true);

            const url = new URL(`${BASE_API_URL}/${endpoint}`);
            // Add TNS alias to all requests
            if (selectedTNS) {
                url.searchParams.append('tns_alias', selectedTNS);
            }
            // Add other params
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

            console.log(`Frontend: Fetching from ${url.toString()}`);
            try {
                const response = await fetch(url.toString());
                // Check if the response is JSON before parsing
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }
                    console.log(`Frontend: Data received from ${endpoint}:`, data);
                    return data;
                } else {
                    const text = await response.text();
                    console.error(`Frontend: Non-JSON response from ${endpoint}:`, text);
                    throw new Error(`Server responded with non-JSON content or error: ${text.substring(0, 100)}...`); // Show a snippet
                }
            } catch (error) {
                console.error(`Frontend: Error fetching ${endpoint}:`, error);
                showGlobalMessage('error', `Erro ao carregar dados de ${endpoint}: ${error.message}`);
                return null;
            } finally {
                toggleLoading(false);
            }
        }

        // Modified postData to accept modalId
        async function postData(endpoint, payload, successMessage = 'Operação concluída com sucesso.') {
            clearPopupMessage(); // Clear any active pop-up for new POST request
            toggleLoading(true);

            const url = `${BASE_API_URL}/${endpoint}`;
            // Add TNS alias to all POST requests
            if (selectedTNS && !payload.tns_alias) {
                payload.tns_alias = selectedTNS;
            }
            
            // The admin_password is now expected to be part of the payload passed to postData
            // No automatic injection here.

            console.log(`Frontend: Posting to ${url}, Payload:`, payload);
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                // Check if the response is JSON before parsing
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }
                    showPopupMessage('success', successMessage);
                    console.log(`Frontend: POST ${endpoint} successful:`, data);
                    return data;
                } else {
                    const text = await response.text();
                    console.error(`Frontend: Non-JSON response from ${endpoint}:`, text);
                    throw new Error(`Server responded with non-JSON content or error: ${text.substring(0, 100)}...`); // Show a snippet
                }
            } catch (error) {
                console.error(`Frontend: Error posting to ${endpoint}:`, error);
                showPopupMessage('error', `Erro: ${error.message}`);
                return null;
            } finally {
                toggleLoading(false);
            }
        }

        // --- Core Data Loading Functions ---
        async function fetchTnsList() {
            console.log("Frontend: Iniciando fetchTnsList...");
            const data = await fetchData('tns_list');
            const tnsSelect = document.getElementById('tns-select');
            tnsSelect.innerHTML = ''; // Clear existing options

            if (data && data.length > 0) {
                tnsList = data;
                data.forEach(tns => {
                    const option = document.createElement('option');
                    option.value = tns;
                    option.textContent = tns;
                    tnsSelect.appendChild(option);
                });
                selectedTNS = tnsList[0]; // Set default selected TNS
                tnsSelect.value = selectedTNS; // Corrected: used selectedTNS
                console.log("Frontend: TNS list loaded successfully:", tnsList); // Log para depuração
            } else {
                tnsList = [];
                selectedTNS = '';
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum TNS configurado';
                tnsSelect.appendChild(option);
                showGlobalMessage('error', 'Nenhum TNS configurado no backend. Verifique o arquivo config.ini.');
                console.warn("Frontend: No TNS configurations found."); // Log para depuração
            }
            console.log("Frontend: Finalizando fetchTnsList.");
        }

        async function fetchUiConfig() {
            console.log("Frontend: Iniciando fetchUiConfig...");
            try {
                const response = await fetch(`${BASE_API_URL}/config`);
                const config = await response.json();
                if (response.ok) {
                    uiConfig = config;
                    console.log("Frontend: UI Config loaded:", uiConfig);
                } else {
                    console.error("Failed to fetch UI config:", config.error);
                    // Fallback to default if fetch fails
                    uiConfig = { enable_active_sessions: true, enable_instance_health: true, enable_session_status_box: true, enable_top_users_box: true, enable_top_programs_box: true, enable_waiting_sessions_box: true, enable_blocked_sessions_box: true };
                }
            } catch (error) {
                console.error("Network error fetching UI config:", error);
                // Fallback to default on network error
                uiConfig = { enable_active_sessions: true, enable_instance_health: true, enable_session_status_box: true, enable_top_users_box: true, enable_top_programs_box: true, enable_waiting_sessions_box: true, enable_blocked_sessions_box: true };
            }
            console.log("Frontend: Finalizando fetchUiConfig.");
        }

        // Function to fetch and display the application version
        async function fetchAppVersion() {
            console.log("Frontend: Iniciando fetchAppVersion...");
            try {
                const response = await fetch(`${BASE_API_URL}/app_version`);
                const data = await response.json();
                if (response.ok && data.version) {
                    document.getElementById('app-version-display').textContent = data.version;
                    console.log("Frontend: Versão da aplicação carregada:", data.version);
                } else {
                    document.getElementById('app-version-display').textContent = 'N/A';
                    console.error('Failed to fetch app version:', data.error || 'Unknown error');
                }
            } catch (error) {
                document.getElementById('app-version-display').textContent = 'Erro';
                console.error('Network error fetching app version:', error);
            }
            console.log("Frontend: Finalizando fetchAppVersion.");
        }

        // Helper function to get a consistent color for a given name
        const colorCache = {};
        const colorPalette = [
            'rgb(75, 192, 192)', 'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)',
            'rgb(153, 102, 255)', 'rgb(255, 159, 64)', 'rgb(201, 203, 207)', 'rgb(100, 149, 237)',
            'rgb(255, 0, 255)', 'rgb(0, 255, 255)', 'rgb(128, 0, 0)', 'rgb(0, 128, 0)'
        ];
        let colorIndex = 0;

        function getColor(name) {
            if (!colorCache[name]) {
                colorCache[name] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            return colorCache[name];
        }

        // Function to render the combined history chart (MODIFICADO)
        function renderCombinedHistoryChart(data, canvasId, chartType = 'line', viewFilter = 'all') { // Added viewFilter parameter
            console.log(`Frontend: Iniciando renderCombinedHistoryChart para ${canvasId} com tipo ${chartType} e filtro ${viewFilter}.`);
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (combinedHistoryChartInstance) {
                combinedHistoryChartInstance.destroy();
                combinedHistoryChartInstance = null; // Explicitly set to null after destruction
            }

            console.log(`Frontend: renderCombinedHistoryChart recebido dados:`, data);

            const allTimestamps = new Set();
            const tablespaceNames = new Set();
            const schemaNames = new Set();

            // Collect all unique timestamps and names
            data.tablespace_individual_history.forEach(item => {
                allTimestamps.add(item.timestamp);
                tablespaceNames.add(item.name);
            });
            data.schema_individual_history.forEach(item => {
                allTimestamps.add(item.timestamp);
                schemaNames.add(item.name);
            });

            const sortedTimestamps = Array.from(allTimestamps).sort();
            
            // Prepare labels and x-axis data based on chart type
            let labelsOrXData;
            let xScaleType;

            if (chartType === 'scatter') {
                // For scatter, x-axis data needs to be numerical (timestamps)
                labelsOrXData = sortedTimestamps.map(ts => new Date(ts).getTime()); // Milliseconds since epoch
                xScaleType = 'time'; // Use 'time' scale for better date handling
            } else {
                // For line and bar, labels are strings representing date/time
                labelsOrXData = sortedTimestamps.map(ts => new Date(ts).toLocaleString());
                xScaleType = 'category'; // Default for string labels
            }

            const datasets = [];

            // Create datasets for each tablespace, if filter allows
            if (viewFilter === 'all' || viewFilter === 'tablespaces') {
                tablespaceNames.forEach(tsName => {
                    const tsDataMap = new Map(data.tablespace_individual_history
                        .filter(item => item.name === tsName)
                        .map(item => [item.timestamp, item.value]));

                    let values;
                    if (chartType === 'scatter') {
                        values = sortedTimestamps.map(ts => {
                            const yValue = tsDataMap.get(ts);
                            return yValue !== undefined ? { x: new Date(ts).getTime(), y: yValue } : null;
                        }).filter(item => item !== null); // Filter out nulls if data is sparse
                    } else {
                        values = sortedTimestamps.map(ts => tsDataMap.get(ts) || null);
                    }
                    
                    const color = getColor(tsName); // Get consistent color

                    datasets.push({
                        label: `TS: ${tsName} (%)`,
                        data: values,
                        borderColor: color,
                        backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.2)'), // Light fill
                        fill: chartType === 'line' ? true : false, // Fill only for line charts
                        tension: chartType === 'line' ? 0.1 : 0, // Tension only for line charts
                        yAxisID: 'y-percent',
                        pointRadius: chartType === 'scatter' ? 5 : 3, // Larger points for scatter
                        showLine: chartType !== 'bar' // Don't show line for bar charts
                    });
                });
            }

            // Create datasets for each schema, if filter allows
            if (viewFilter === 'all' || viewFilter === 'schemas') {
                schemaNames.forEach(schemaName => {
                    const schemaDataMap = new Map(data.schema_individual_history
                        .filter(item => item.name === schemaName)
                        .map(item => [item.timestamp, item.value]));

                    let values;
                    if (chartType === 'scatter') {
                        values = sortedTimestamps.map(ts => {
                            const yValue = schemaDataMap.get(ts);
                            return yValue !== undefined ? { x: new Date(ts).getTime(), y: yValue } : null;
                        }).filter(item => item !== null); // Filter out nulls if data is sparse
                    } else {
                        values = sortedTimestamps.map(ts => schemaDataMap.get(ts) || null);
                    }

                    const color = getColor(schemaName); // Get consistent color

                    datasets.push({
                        label: `Schema: ${schemaName} (GB)`,
                        data: values,
                        borderColor: color,
                        backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.2)'), // Light fill
                        fill: chartType === 'line' ? true : false, // Fill only for line charts
                        tension: chartType === 'line' ? 0.1 : 0, // Tension only for line charts
                        yAxisID: 'y-gb',
                        pointRadius: chartType === 'scatter' ? 5 : 3, // Larger points for scatter
                        showLine: chartType !== 'bar' // Don't show line for bar charts
                    });
                });
            }

            if (datasets.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Arial";
                ctx.fillStyle = "#888";
                ctx.textAlign = "center";
                ctx.fillText("Nenhum dado de histórico combinado disponível para a seleção.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                console.warn("Frontend: Nenhum dado de histórico combinado disponível para a seleção, exibindo mensagem no canvas.");
                return;
            }

            combinedHistoryChartInstance = new Chart(ctx, {
                type: chartType, // Use the selected chart type
                data: {
                    labels: chartType !== 'scatter' ? labelsOrXData : undefined, // Labels only for line/bar
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    stacked: false,
                    scales: {
                        x: {
                            type: xScaleType, // Dynamic x-axis type
                            title: {
                                display: true,
                                text: 'Data/Hora'
                            },
                            ...(xScaleType === 'time' && {
                                time: {
                                    unit: 'hour', // or 'day', 'month', etc.
                                    tooltipFormat: 'DD/MM/YYYY HH:mm:ss',
                                    displayFormats: {
                                        hour: 'DD/MM/YYYY HH:mm',
                                        day: 'DD/MM/YYYY',
                                        month: 'MM/YYYY',
                                        year: 'YYYY'
                                    }
                                },
                                adapters: {
                                    date: {
                                        // This assumes you have Luxon or Moment.js loaded.
                                    }
                                }
                            })
                        },
                        'y-percent': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Uso (%)'
                            },
                            beginAtZero: true,
                            max: 100 // Tablespace percentage goes up to 100%
                        },
                        'y-gb': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Uso (GB)'
                            },
                            grid: {
                                drawOnChartArea: false, // Only draw grid lines for the first axis
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            console.log(`Frontend: Gráfico de histórico combinado (${chartType}) renderizado com sucesso.`);
        }

        // Function to fetch and render combined history data
        async function fetchCombinedHistoryData() {
            console.log("Frontend: Iniciando fetchCombinedHistoryData...");
            const startDate = document.getElementById('combined-history-start-date').value;
            const endDate = document.getElementById('combined-history-end-date').value;
            const chartType = document.getElementById('combined-history-chart-type').value;
            const viewFilter = document.getElementById('combined-history-view-filter').value; // Get selected view filter

            const params = {};
            if (startDate) params.start_date = startDate + 'T00:00:00';
            if (endDate) params.end_date = endDate + 'T23:59:59';

            const data = await fetchData('combined_history', params);
            if (data) {
                renderCombinedHistoryChart(data, 'combined-history-chart', chartType, viewFilter); // Pass viewFilter
            } else {
                showPopupMessage('error', 'Falha ao carregar histórico combinado.');
                const ctx = document.getElementById('combined-history-chart').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                if (combinedHistoryChartInstance) {
                    combinedHistoryChartInstance.destroy();
                    combinedHistoryChartInstance = null;
                }
            }
            console.log("Frontend: Finalizando fetchCombinedHistoryData.");
        }

        async function loadDataForSelectedTNS() {
            console.log("Frontend: Iniciando loadDataForSelectedTNS...");
            clearPopupMessage();
            toggleLoading(true);

            selectedTNS = document.getElementById('tns-select').value;
            if (!selectedTNS) {
                showGlobalMessage('error', 'Por favor, selecione um TNS para carregar os dados.');
                toggleLoading(false);
                console.log("Frontend: TNS não selecionado, abortando loadDataForSelectedTNS.");
                return;
            }

            // Update displayed TNS
            document.getElementById('connected-tns').textContent = selectedTNS;

            // Fetch UI config first
            await fetchUiConfig();

            // Reset all data displays
            document.getElementById('total-gb').textContent = 'Carregando...';
            document.getElementById('free-gb').textContent = 'Carregando...';
            document.getElementById('used-gb').textContent = 'Carregando...';
            document.getElementById('used-percent').textContent = 'Carregando...';
            document.getElementById('tablespace-body').innerHTML = '';
            document.getElementById('schema-body').innerHTML = '';
            document.getElementById('session-status-summary').innerHTML = '';
            document.getElementById('top-users-list').innerHTML = '';
            document.getElementById('top-programs-list').innerHTML = '';
            document.getElementById('waiting-sessions-list').innerHTML = '';
            document.getElementById('blocked-sessions-list').innerHTML = '';
            document.getElementById('instance-name').textContent = 'Carregando...';
            document.getElementById('instance-status').textContent = 'Carregando...';
            document.getElementById('host-name').textContent = 'Carregando...';
            document.getElementById('instance-version').textContent = 'Carregando...';
            document.getElementById('startup-time').textContent = 'Carregando...';

            // Fetch and render overall DB space
            const dbSpace = await fetchData('db_space');
            if (dbSpace) {
                document.getElementById('total-gb').textContent = dbSpace.total_gb.toFixed(2) + ' GB';
                document.getElementById('free-gb').textContent = dbSpace.free_gb.toFixed(2) + ' GB';
                document.getElementById('used-gb').textContent = dbSpace.used_gb.toFixed(2) + ' GB';
                document.getElementById('used-percent').textContent = dbSpace.used_percent.toFixed(2) + '%';
            }

            // Fetch and render tablespace data
            tablespaceData = await fetchData('tablespace_space');
            renderTablespaceData(tablespaceData);

            // Fetch and render schema data
            schemaData = await fetchData('all_schemas');
            renderSchemaData(schemaData);

            // Conditionally display active sessions section
            const activeSessionsSection = document.getElementById('active-sessions-section');
            if (uiConfig.enable_active_sessions) {
                activeSessionsSection.style.display = 'block';
                activeSessionsData = await fetchData('active_sessions');
                renderActiveSessions(activeSessionsData);
            } else {
                activeSessionsSection.style.display = 'none';
            }

            // Conditionally display instance health section
            const instanceHealthSection = document.getElementById('instance-health-section');
            if (uiConfig.enable_instance_health) {
                instanceHealthSection.style.display = 'block';
                instanceHealthData = await fetchData('instance_health');
                renderInstanceHealth(instanceHealthData);
            } else {
                instanceHealthSection.style.display = 'none';
            }

            // Fetch and render combined history chart (now defined)
            // Reset filters and chart type to default when TNS changes
            document.getElementById('combined-history-start-date').value = ''; 
            document.getElementById('combined-history-end-date').value = '';   
            document.getElementById('combined-history-chart-type').value = 'line'; // Reset to line
            document.getElementById('combined-history-view-filter').value = 'all'; // Reset view filter to 'all'
            await fetchCombinedHistoryData();


            toggleLoading(false);
            console.log("Frontend: Finalizando loadDataForSelectedTNS.");
        }

        // --- Sorting Function for Schema Table ---
        function sortSchemaTable(columnName) {
            console.log(`Frontend: Iniciando sortSchemaTable para coluna '${columnName}'.`);
            // Determine new sort direction
            if (currentSchemaSortColumn === columnName) {
                currentSchemaSortDirection = (currentSchemaSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                currentSchemaSortColumn = columnName;
                currentSchemaSortDirection = 'asc'; // Default to ascending for new column
            }

            // Clear all sort icons
            document.querySelectorAll('#schema-table th .sort-icon').forEach(icon => {
                icon.textContent = '';
                icon.parentElement.classList.remove('sort-asc', 'sort-desc');
            });

            // Set current sort icon
            const currentHeader = document.querySelector(`#schema-table th[onclick*="sortSchemaTable('${columnName}')"]`);
            if (currentHeader) {
                currentHeader.classList.add(`sort-${currentSchemaSortDirection}`);
                currentHeader.querySelector('.sort-icon').textContent = currentSchemaSortDirection === 'asc' ? ' ▲' : ' ▼';
            }

            // Re-render the schema table with sorted data
            renderSchemaData(schemaData);
            console.log(`Frontend: Finalizando sortSchemaTable para coluna '${columnName}'.`);
        }

        // --- Sorting Function for Tablespace Table ---
        function sortTablespaceTable(columnName) {
            console.log(`Frontend: Iniciando sortTablespaceTable para coluna '${columnName}'.`);
            if (currentTablespaceSortColumn === columnName) {
                currentTablespaceSortDirection = (currentTablespaceSortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                currentTablespaceSortColumn = columnName;
                currentTablespaceSortDirection = 'asc';
            }

            document.querySelectorAll('#tablespace-table th .sort-icon').forEach(icon => {
                icon.textContent = '';
                icon.parentElement.classList.remove('sort-asc', 'sort-desc');
            });

            const currentHeader = document.querySelector(`#tablespace-table th[onclick*="sortTablespaceTable('${columnName}')"]`);
            if (currentHeader) {
                currentHeader.classList.add(`sort-${currentTablespaceSortDirection}`);
                currentHeader.querySelector('.sort-icon').textContent = currentTablespaceSortDirection === 'asc' ? ' ▲' : ' ▼';
            }

            renderTablespaceData(tablespaceData);
            console.log(`Frontend: Finalizando sortTablespaceTable para coluna '${columnName}'.`);
        }


        // --- Rendering Functions for Main Sections ---
        function renderTablespaceData(data) {
            console.log("Frontend: Iniciando renderTablespaceData...");
            const tbody = document.getElementById('tablespace-body');
            tbody.innerHTML = ''; // Clear previous data

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhum tablespace encontrado.</td></tr>';
                console.warn("Frontend: Nenhum tablespace encontrado, exibindo mensagem.");
                return;
            }

            // Apply sorting to tablespaceData
            let sortedTablespaceData = [...data]; // Create a copy to sort
            sortedTablespaceData.sort((a, b) => {
                let valA, valB;

                if (currentTablespaceSortColumn === 'total_gb' || currentTablespaceSortColumn === 'free_gb' || currentTablespaceSortColumn === 'used_gb' || currentTablespaceSortColumn === 'used_percent') {
                    valA = a[currentTablespaceSortColumn] || 0;
                    valB = b[currentTablespaceSortColumn] || 0;
                } else if (currentTablespaceSortColumn === 'name' || currentTablespaceSortColumn === 'status') {
                    valA = (a[currentTablespaceSortColumn] || '').toLowerCase();
                    valB = (b[currentTablespaceSortColumn] || '').toLowerCase();
                } else {
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                }

                if (valA < valB) {
                    return currentTablespaceSortDirection === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return currentTablespaceSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });


            sortedTablespaceData.forEach(ts => {
                console.log('Rendering tablespace:', ts); // Debug log for each tablespace
                const row = document.createElement('tr');
                row.className = `bg-white border-b hover:bg-gray-50 ${ts.status ? 'status-' + ts.status.toLowerCase() : ''}`; // Add status class
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ts.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ts.total_gb.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ts.free_gb.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ts.used_gb.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ts.used_percent.toFixed(2)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ts.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                        <button onclick='openTablespaceDetailsModal(${JSON.stringify(ts.name)})' class="table-action-button">Detalhes</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            console.log("Frontend: Tablespace data rendered.");
        }

        function renderSchemaData(data) {
            console.log("Frontend: Iniciando renderSchemaData...");
            const tbody = document.getElementById('schema-body');
            tbody.innerHTML = ''; // Clear previous data

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum schema encontrado.</td></tr>';
                console.warn("Frontend: Nenhum schema encontrado, exibindo mensagem.");
                return;
            }

            // Apply search filter
            const searchTerm = document.getElementById('schema-search').value.toLowerCase();
            let filteredAndSortedData = data.filter(schema => schema.name.toLowerCase().includes(searchTerm));

            // Apply sorting
            filteredAndSortedData.sort((a, b) => {
                let valA, valB;

                if (currentSchemaSortColumn === 'used_gb') {
                    valA = a.used_gb || 0; // Handle null/undefined for numeric sort
                    valB = b.used_gb || 0;
                } else if (currentSchemaSortColumn === 'name' || currentSchemaSortColumn === 'account_status') {
                    valA = (a[currentSchemaSortColumn] || '').toLowerCase();
                    valB = (b[currentSchemaSortColumn] || '').toLowerCase();
                } else {
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                }

                if (valA < valB) {
                    return currentSchemaSortDirection === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return currentSchemaSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });

            if (filteredAndSortedData.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum schema corresponde à sua pesquisa.</td></tr>';
                 console.warn("Frontend: Nenhum schema corresponde à pesquisa, exibindo mensagem.");
                 return;
            }

            filteredAndSortedData.forEach(schema => {
                console.log('Rendering schema:', schema); // Debug log for each schema
                const row = document.createElement('tr');
                // Use schema.account_status for styling classes, converting to lowercase and replacing spaces/hyphens
                let statusClass = schema.account_status ? 'status-' + schema.account_status.toLowerCase().replace(/[^a-z0-9]/g, '-') : 'status-unknown';
                
                // NEW: Check if schema is currently dropping
                if (droppingSchemas[schema.name]) {
                    statusClass = 'status-dropping'; // Apply specific style for dropping
                }
                // NEW: Check if schema is currently backing up
                if (schema.account_status === 'Backup em andamento') {
                    statusClass = 'status-backup-em-andamento';
                }


                // Escape schema.name for use in onclick attribute
                const escapedSchemaName = JSON.stringify(schema.name); // Use JSON.stringify for robust escaping

                row.className = `bg-white border-b hover:bg-gray-50 ${statusClass}`;
                row.setAttribute('data-schema-name', schema.name); // Add data attribute to easily find the row
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${schema.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${schema.used_gb ? schema.used_gb.toFixed(2) : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${schema.account_status || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                        <button onclick='openSchemaDetailsModal(${escapedSchemaName})' class="table-action-button">Detalhes</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            console.log("Frontend: Schema data rendered.");
        }

        function renderActiveSessions(data) {
            console.log("Frontend: Iniciando renderActiveSessions...");
            if (!data) {
                document.getElementById('total-sessions').textContent = 'N/A';
                document.getElementById('session-status-summary').innerHTML = '<li>Dados indisponíveis.</li>';
                document.getElementById('top-users-list').innerHTML = '<li>Dados indisponíveis.</li>';
                document.getElementById('top-programs-list').innerHTML = '<li>Dados indisponíveis.</li>';
                document.getElementById('waiting-sessions-list').innerHTML = '<li>Dados indisponíveis.</li>';
                document.getElementById('blocked-sessions-list').innerHTML = '<li>Dados indisponíveis.</li>';
                console.warn("Frontend: Dados de sessões ativas indisponíveis.");
                return;
            }

            // Total Sessions
            document.getElementById('total-sessions').textContent = data.total_sessions || '0';

            // Session Status Summary
            const statusSummaryUl = document.getElementById('session-status-summary');
            statusSummaryUl.innerHTML = '';
            if (uiConfig.enable_session_status_box && data.status_summary && data.status_summary.length > 0) {
                document.getElementById('session-status-box').style.display = 'block';
                data.status_summary.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.status}: ${item.count}`;
                    statusSummaryUl.appendChild(li);
                });
            } else {
                document.getElementById('session-status-box').style.display = 'none';
            }

            // Top Users
            const topUsersList = document.getElementById('top-users-list');
            topUsersList.innerHTML = '';
            if (uiConfig.enable_top_users_box && data.top_users && data.top_users.length > 0) {
                document.getElementById('top-users-box').style.display = 'block';
                data.top_users.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.username}: ${item.count}`;
                    topUsersList.appendChild(li);
                });
            } else {
                document.getElementById('top-users-box').style.display = 'none';
            }

            // Top Programs
            const topProgramsList = document.getElementById('top-programs-list');
            topProgramsList.innerHTML = '';
            if (uiConfig.enable_top_programs_box && data.top_programs && data.top_programs.length > 0) {
                document.getElementById('top-programs-box').style.display = 'block';
                data.top_programs.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.program}: ${item.count}`;
                    topProgramsList.appendChild(li);
                });
            } else {
                document.getElementById('top-programs-box').style.display = 'none';
            }

            // Waiting Sessions
            const waitingSessionsList = document.getElementById('waiting-sessions-list');
            waitingSessionsList.innerHTML = '';
            if (uiConfig.enable_waiting_sessions_box && data.waiting_sessions && data.waiting_sessions.length > 0) {
                document.getElementById('waiting-sessions-box').style.display = 'block';
                data.waiting_sessions.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.event} (${item.wait_class}): ${item.count}`;
                    waitingSessionsList.appendChild(li);
                });
            } else {
                document.getElementById('waiting-sessions-box').style.display = 'none';
            }

            // Blocked Sessions
            const blockedSessionsList = document.getElementById('blocked-sessions-list');
            blockedSessionsList.innerHTML = '';
            if (uiConfig.enable_blocked_sessions_box && data.blocked_sessions && data.blocked_sessions.length > 0) {
                document.getElementById('blocked-sessions-box').style.display = 'block';
                data.blocked_sessions.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Bloqueador:</strong> ${item.blocking_user} (SID: ${item.blocking_sid})<br><strong>Bloqueado:</strong> ${item.blocked_user} (SID: ${item.blocked_sid})<br><strong>Evento:</strong> ${item.blocked_event}`;
                    blockedSessionsList.appendChild(li);
                });
            } else {
                document.getElementById('blocked-sessions-box').style.display = 'none';
            }
            console.log("Frontend: Active sessions rendered.");
        }

        function renderInstanceHealth(data) {
            console.log("Frontend: Iniciando renderInstanceHealth...");
            if (!data) {
                document.getElementById('instance-name').textContent = 'N/A';
                document.getElementById('instance-status').textContent = 'N/A';
                document.getElementById('host-name').textContent = 'N/A';
                document.getElementById('instance-version').textContent = 'N/A';
                document.getElementById('startup-time').textContent = 'N/A';
                document.getElementById('connected-tns').textContent = 'N/A';
                console.warn("Frontend: Dados de saúde da instância indisponíveis.");
                return;
            }
            document.getElementById('instance-name').textContent = data.instance_name || 'N/A';
            document.getElementById('instance-status').textContent = data.status || 'N/A';
            document.getElementById('host-name').textContent = data.host_name || 'N/A';
            document.getElementById('instance-version').textContent = data.version || 'N/A';
            document.getElementById('startup-time').textContent = data.startup_time || 'N/A';
            document.getElementById('connected-tns').textContent = data.connected_tns || 'N/A';
            console.log("Frontend: Instance health rendered.");
        }

        // --- Modal Specific Rendering and Functions ---

        // Helper function to render datafiles
        function _renderDatafiles(datafiles) {
            console.log("Frontend: Iniciando _renderDatafiles...");
            const datafilesBody = document.getElementById('datafiles-body');
            datafilesBody.innerHTML = ''; // Clear previous data
            document.getElementById('no-datafiles-message').classList.add('hidden');

            if (datafiles && datafiles.length > 0) {
                datafiles.forEach(file => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${file.file_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.size_gb.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.max_size_gb.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.autoextensible}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                            <button onclick='openResizeDatafileModal(${JSON.stringify(file.file_name)}, ${file.size_gb}, ${JSON.stringify(file.autoextensible)})' class="table-action-button">Redimensionar</button>
                        </td>
                    `;
                    datafilesBody.appendChild(row);
                });
            } else {
                document.getElementById('no-datafiles-message').classList.add('hidden');
                console.warn("Frontend: Nenhum datafile encontrado, exibindo mensagem.");
            }
            console.log("Frontend: Datafiles rendered.");
        }

        // Helper function to render tablespace top objects
        function _renderTablespaceTopObjects(topObjects) {
            console.log("Frontend: Iniciando _renderTablespaceTopObjects...");
            const topObjectsBody = document.getElementById('tablespace-top-objects-body');
            topObjectsBody.innerHTML = ''; // Clear previous data
            document.getElementById('no-tablespace-objects-message').classList.add('hidden');

            if (topObjects && topObjects.length > 0) {
                topObjects.forEach(obj => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${obj.owner}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obj.segment_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obj.segment_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obj.size_mb.toFixed(2)}</td>
                    `;
                    topObjectsBody.appendChild(row);
                });
            } else {
                document.getElementById('no-tablespace-objects-message').classList.add('hidden');
                console.warn("Frontend: Nenhum objeto encontrado neste tablespace, exibindo mensagem.");
            }
            console.log("Frontend: Tablespace top objects rendered.");
        }

        // Helper functions for rendering schema details (moved to global scope)
        function _renderSchemaGrants(roleGrants, sysGrants, tabGrants) {
            console.log("Frontend: Iniciando _renderSchemaGrants...");
            const roleGrantsBody = document.getElementById('schema-role-grants-body');
            roleGrantsBody.innerHTML = '';
            document.getElementById('no-schema-role-grants-message').classList.add('hidden');
            if (roleGrants && roleGrants.length > 0) {
                roleGrants.forEach(grant => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${grant.privilege}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grant.admin_option}</td>
                    `;
                    roleGrantsBody.appendChild(row);
                });
            } else {
                document.getElementById('no-schema-role-grants-message').classList.add('hidden');
                console.warn("Frontend: Nenhuma role encontrada para este schema, exibindo mensagem.");
            }

            const sysGrantsBody = document.getElementById('schema-sys-grants-body');
            sysGrantsBody.innerHTML = '';
            document.getElementById('no-schema-sys-grants-message').classList.add('hidden');
            if (sysGrants && sysGrants.length > 0) {
                sysGrants.forEach(grant => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${grant.privilege}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grant.admin_option}</td>
                    `;
                    sysGrantsBody.appendChild(row);
                });
            } else {
                document.getElementById('no-schema-sys-grants-message').classList.add('hidden');
                console.warn("Frontend: Nenhum privilégio de sistema encontrado para este schema, exibindo mensagem.");
            }

            const tabGrantsBody = document.getElementById('schema-tab-grants-body');
            tabGrantsBody.innerHTML = '';
            document.getElementById('no-schema-tab-grants-message').classList.add('hidden');
            if (tabGrants && tabGrants.length > 0) {
                tabGrants.forEach(grant => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${grant.owner}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grant.table_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grant.privilege}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grant.grantable}</td>
                    `;
                    tabGrantsBody.appendChild(row);
                });
            } else {
                document.getElementById('no-schema-tab-grants-message').classList.add('hidden');
                console.warn("Frontend: Nenhum privilégio de objeto encontrado para este schema, exibindo mensagem.");
            }
            console.log("Frontend: Schema grants rendered.");
        }

        function _renderSchemaTopObjects(topObjects) {
            console.log("Frontend: Iniciando _renderSchemaTopObjects...");
            const topObjectsBody = document.getElementById('schema-top-objects-body');
            topObjectsBody.innerHTML = '';
            document.getElementById('no-schema-top-objects-message').classList.add('hidden');
            if (topObjects && topObjects.length > 0) {
                topObjects.forEach(obj => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${obj.segment_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obj.segment_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obj.size_mb.toFixed(2)}</td>
                    `;
                    topObjectsBody.appendChild(row);
                });
            } else {
                document.getElementById('no-schema-top-objects-message').classList.add('hidden');
                console.warn("Frontend: Nenhum objeto (tabela) encontrado neste schema, exibindo mensagem.");
            }
            console.log("Frontend: Schema top objects rendered.");
        }

        function _renderSchemaObjectCounts(objectCounts) {
            console.log("Frontend: Iniciando _renderSchemaObjectCounts...");
            const objectCountsBody = document.getElementById('schema-object-counts-body');
            objectCountsBody.innerHTML = '';
            document.getElementById('no-schema-object-counts-message').classList.add('hidden');
            if (objectCounts && objectCounts.length > 0) {
                objectCounts.forEach(obj => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${obj.object_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obj.count}</td>
                    `;
                    objectCountsBody.appendChild(row);
                });
            } else {
                document.getElementById('no-schema-object-counts-message').classList.add('hidden');
                console.warn("Frontend: Nenhum tipo de objeto encontrado neste schema, exibindo mensagem.");
            }
            console.log("Frontend: Schema object counts rendered.");
        }

        // Tablespace Details Modal
        async function openTablespaceDetailsModal(tablespaceName) {
            console.log(`Frontend: Abrindo modal de detalhes do tablespace para: ${tablespaceName}`);
            openModal('tablespace-details-modal');
            document.getElementById('tablespace-details-title').textContent = `Detalhes do Tablespace: ${tablespaceName}`;

            // Set current tablespace for forms
            currentTablespaceForDatafile = tablespaceName;

            // Reset date filters
            document.getElementById('tablespace-history-start-date').value = '';
            document.getElementById('tablespace-history-end-date').value = '';
            // Reset chart type to default (line)
            document.getElementById('tablespace-history-chart-type').value = 'line';


            // Reset add datafile form
            document.getElementById('add-datafile-form').reset();
            document.getElementById('autoextend-options').classList.add('hidden');
            document.getElementById('new-datafile-autoextend').checked = false;
            document.getElementById('new-datafile-name').value = '';
            document.getElementById('new-datafile-size').value = 100;
            document.getElementById('new-datafile-size-unit').value = 'MB'; // Default to MB
            document.getElementById('new-datafile-next-size').value = '';
            document.getElementById('new-datafile-next-size-unit').value = 'MB'; // Default to MB
            document.getElementById('new-datafile-max-size').value = '';
            document.getElementById('new-datafile-max-size-unit').value = 'MB'; // Default to MB


            const data = await fetchData(`tablespace_details?name=${tablespaceName}`);
            console.log("Frontend: Dados de detalhes do tablespace recebidos:", data); // Log the full data

            if (data) {
                _renderDatafiles(data.datafiles);
                _renderTablespaceTopObjects(data.top_objects);
                renderTablespaceHistoryChart(data.history_data, 'tablespace-history-chart', 'line'); // Initial render with default 'line'
            } else {
                showModalMessage('tablespace-details-modal', 'error', 'Falha ao carregar detalhes do tablespace.');
            }
            console.log("Frontend: Modal de detalhes do tablespace aberto e dados carregados.");
        }

        // Apply Tablespace History Filter
        async function applyTablespaceHistoryFilter() {
            console.log("Frontend: Aplicando filtro de histórico do tablespace...");
            const tablespaceName = currentTablespaceForDatafile;
            const startDate = document.getElementById('tablespace-history-start-date').value;
            const endDate = document.getElementById('tablespace-history-end-date').value;
            const chartType = document.getElementById('tablespace-history-chart-type').value; // Get selected chart type

            const params = { name: tablespaceName };
            if (startDate) params.start_date = startDate + 'T00:00:00'; // Add time for full day
            if (endDate) params.end_date = endDate + 'T23:59:59'; // Add time for full day

            const data = await fetchData('tablespace_details', params); // Use tablespace_details, which now returns history
            if (data) {
                renderTablespaceHistoryChart(data.history_data, 'tablespace-history-chart', chartType); // Pass chartType
            } else {
                showPopupMessage('error', 'Falha ao aplicar filtro de histórico do tablespace.');
                const ctx = document.getElementById('tablespace-history-chart').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            }
            console.log("Frontend: Filtro de histórico do tablespace aplicado.");
        }

        // Add Datafile Form Submission
        document.getElementById('add-datafile-form').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission
            console.log("Frontend: Submissão do formulário Adicionar Datafile.");

            const form = event.target;
            const datafileName = form['file_name'].value.trim();
            const datafileSizeValue = parseInt(form['size_value'].value);
            const datafileSizeUnit = form['size_unit'].value;
            const autoextend = form['autoextend'].checked;

            let datafileNextSizeValue = null;
            let datafileNextSizeUnit = null;
            let datafileMaxSizeValue = null;
            let datafileMaxSizeUnit = null;

            if (!datafileName || isNaN(datafileSizeValue) || datafileSizeValue <= 0) {
                showPopupMessage('error', 'Por favor, preencha o nome e o tamanho inicial do datafile.');
                console.error("Frontend: Validação do formulário falhou: nome ou tamanho inicial inválido.");
                return;
            }

            if (autoextend) {
                datafileNextSizeValue = parseInt(form['next_size_value'].value);
                datafileNextSizeUnit = form['next_size_unit'].value;
                datafileMaxSizeValue = parseInt(form['max_size_value'].value);
                datafileMaxSizeUnit = form['max_size_unit'].value;

                if (isNaN(datafileNextSizeValue) || datafileNextSizeValue <= 0) {
                    showPopupMessage('error', 'O próximo incremento para autoextend deve ser um número positivo.');
                    console.error("Frontend: Validação do formulário falhou: próximo incremento inválido.");
                    return;
                }
                if (datafileMaxSizeValue !== null && (isNaN(datafileMaxSizeValue) || datafileMaxSizeValue <= datafileSizeValue)) {
                    showPopupMessage('error', 'O tamanho máximo para autoextend deve ser maior que o tamanho inicial.');
                    console.error("Frontend: Validação do formulário falhou: tamanho máximo inválido.");
                    return;
                }
            }

            const payload = {
                tablespace_name: currentTablespaceForDatafile,
                file_name: datafileName,
                size_value: datafileSizeValue,
                size_unit: datafileSizeUnit,
                autoextend: autoextend,
                next_size_value: datafileNextSizeValue,
                next_size_unit: datafileSizeUnit, // Use the same unit as initial size for NEXT if not specified
                max_size_value: datafileMaxSizeValue,
                max_size_unit: datafileSizeUnit // Use the same unit as initial size for MAXSIZE if not specified
            };

            // Primeiro, exibe o pop-up de confirmação genérico
            console.log("Frontend: Chamando openConfirmationModal para adicionar datafile.");
            openConfirmationModal(`Tem certeza que deseja adicionar o datafile '${datafileName}' ao tablespace '${currentTablespaceForDatafile}'?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para adicionar datafile. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitAddDatafileActual, [payload]);
            });
        });

        async function submitAddDatafileActual(payload, adminPassword) {
            console.log("Frontend: Submetendo adição de datafile...");
            payload.admin_password = adminPassword; // Add admin password to the payload
            const result = await postData('add_datafile', payload, 'Datafile adicionado com sucesso!'); // postData já exibe o pop-up de sucesso/erro
            if (result) {
                // Only refresh the data within the modal, don't close and reopen
                const updatedData = await fetchData(`tablespace_details?name=${currentTablespaceForDatafile}`);
                if (updatedData) {
                    _renderDatafiles(updatedData.datafiles); // Call the internal rendering function
                }
                document.getElementById('add-datafile-form').reset(); // Reset the form after successful submission
                document.getElementById('autoextend-options').classList.add('hidden'); // Hide autoextend options
                document.getElementById('new-datafile-autoextend').checked = false; // Uncheck autoextend
                document.getElementById('new-datafile-size-unit').value = 'MB'; // Reset unit
                document.getElementById('new-datafile-next-size-unit').value = 'MB'; // Reset unit
                document.getElementById('new-datafile-max-size-unit').value = 'MB'; // Reset unit
                console.log("Frontend: Adição de datafile concluída com sucesso.");
            } else {
                console.error("Frontend: Falha na adição do datafile.");
            }
        }

        // Resize Datafile Form Submission
        document.getElementById('resize-datafile-form').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission
            console.log("Frontend: Submissão do formulário Redimensionar Datafile.");

            const form = event.target;
            const fileName = document.getElementById('current-resize-datafile-name').value;
            const newSizeValue = form['new_size_value'].value.trim() !== '' ? parseInt(form['new_size_value'].value) : null;
            const newSizeUnit = form['new_size_unit'].value;
            const autoextend = form['autoextend'].checked;
            let nextSizeValue = null;
            let nextSizeUnit = null;
            let maxSizeValue = null;
            let maxSizeUnit = null;

            if (newSizeValue !== null && (isNaN(newSizeValue) || newSizeValue <= 0)) {
                showPopupMessage('error', 'O novo tamanho deve ser um número positivo.');
                console.error("Frontend: Validação do formulário falhou: novo tamanho inválido.");
                return;
            }
            if (autoextend) {
                nextSizeValue = parseInt(form['next_size_value'].value);
                nextSizeUnit = form['next_size_unit'].value;
                maxSizeValue = parseInt(form['max_size_value'].value);
                maxSizeUnit = form['max_size_unit'].value;

                if (isNaN(nextSizeValue) || nextSizeValue <= 0) { // Corrected variable name from datafileNextSizeValue to nextSizeValue
                    showPopupMessage('error', 'O próximo incremento para autoextend deve ser um número positivo.');
                    console.error("Frontend: Validação do formulário falhou: próximo incremento inválido.");
                    return;
                }
                if (maxSizeValue !== null && (isNaN(maxSizeValue) || (newSizeValue !== null && maxSizeValue < newSizeValue))) {
                    showPopupMessage('error', 'O tamanho máximo para autoextend deve ser maior ou igual ao novo tamanho.');
                    console.error("Frontend: Validação do formulário falhou: tamanho máximo inválido.");
                    return;
                }
            }
            if (!autoextend && newSizeValue === null) {
                showPopupMessage('error', 'Se autoextend estiver desativado, um novo tamanho deve ser especificado.');
                console.error("Frontend: Validação do formulário falhou: novo tamanho não especificado e autoextend desativado.");
                return;
            }

            const payload = {
                file_name: fileName,
                new_size_value: newSizeValue,
                new_size_unit: newSizeUnit,
                autoextend: autoextend,
                next_size_value: nextSizeValue,
                next_size_unit: nextSizeUnit,
                max_size_value: maxSizeValue,
                max_size_unit: maxSizeUnit
            };

            // Primeiro, exibe o pop-up de confirmação genérico
            console.log("Frontend: Chamando openConfirmationModal para redimensionar datafile.");
            openConfirmationModal(`Tem certeza que deseja redimensionar o datafile '${fileName}'?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para redimensionar datafile. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitResizeDatafileActual, [payload]);
            });
        });

        async function submitResizeDatafileActual(payload, adminPassword) {
            console.log("Frontend: Submetendo redimensionamento de datafile...");
            payload.admin_password = adminPassword; // Add admin password to the payload
            const result = await postData('resize_datafile', payload, 'Datafile redimensionado com sucesso!'); // postData já exibe o pop-up de sucesso/erro
            if (result) {
                // Only refresh the data within the modal, don't close and reopen
                const updatedData = await fetchData(`tablespace_details?name=${currentTablespaceForDatafile}`);
                if (updatedData) {
                    _renderDatafiles(updatedData.datafiles); // Call the internal rendering function
                }
                document.getElementById('resize-datafile-form').reset(); // Reset the form after successful submission
                document.getElementById('resize-autoextend-options').classList.add('hidden'); // Hide autoextend options
                document.getElementById('resize-datafile-autoextend').checked = false; // Uncheck autoextend
                document.getElementById('new-resize-size-unit').value = 'MB'; // Reset unit
                document.getElementById('new-resize-next-size-unit').value = 'MB'; // Reset unit
                document.getElementById('new-resize-max-size-unit').value = 'MB'; // Reset unit
                console.log("Frontend: Redimensionamento de datafile concluído com sucesso.");
            } else {
                console.error("Frontend: Falha no redimensionamento do datafile.");
            }
        }

        function openResizeDatafileModal(fileName, currentSizeGb, currentAutoextend) {
            console.log(`Frontend: Abrindo modal de redimensionamento para datafile: ${fileName}`);
            openModal('resize-datafile-modal');
            document.getElementById('resize-datafile-name-display').textContent = fileName;
            document.getElementById('current-resize-datafile-name').value = fileName; // Store for form submission

            // Populate form fields with current data
            document.getElementById('new-resize-size').value = ''; // Start empty for optional resize
            document.getElementById('new-resize-size-unit').value = 'MB'; // Default to MB
            document.getElementById('resize-datafile-autoextend').checked = (currentAutoextend === 'YES');
            document.getElementById('resize-datafile-next-size').value = ''; // Clear or set sensible default
            document.getElementById('resize-datafile-next-size-unit').value = 'MB'; // Default to MB
            document.getElementById('resize-datafile-max-size').value = ''; // Clear
            document.getElementById('resize-datafile-max-size-unit').value = 'MB'; // Default to MB


            // Toggle autoextend options visibility
            const autoextendOptions = document.getElementById('resize-datafile-autoextend');
            const autoextendOptionsDiv = document.getElementById('resize-autoextend-options');
            if (currentAutoextend === 'YES') {
                autoextendOptionsDiv.classList.remove('hidden');
            } else {
                autoextendOptionsDiv.classList.add('hidden');
            }

            // Add event listener for the autoextend checkbox
            autoextendOptions.onchange = function() {
                if (this.checked) {
                    autoextendOptionsDiv.classList.remove('hidden');
                    // Set default values for next and max size if autoextend is turned on and fields are empty
                    if (document.getElementById('resize-datafile-next-size').value === '') {
                        document.getElementById('resize-datafile-next-size').value = 10; // Example default
                    }
                    if (document.getElementById('resize-datafile-max-size').value === '') {
                        document.getElementById('resize-datafile-max-size').value = 32767; // Example default (Oracle max usually)
                    }
                } else {
                    autoextendOptionsDiv.classList.add('hidden');
                }
            };
            // Trigger change event to set initial visibility and defaults based on currentAutoextend
            autoextendOptions.dispatchEvent(new Event('change'));
            console.log("Frontend: Modal de redimensionamento aberto e campos populados.");
        }

        // Schema Details Modal
        async function openSchemaDetailsModal(schemaName) {
            console.log(`Frontend: Abrindo modal de detalhes do schema para: ${schemaName}`);
            openModal('schema-details-modal');
            document.getElementById('schema-details-title').textContent = `Detalhes do Schema: ${schemaName}`;
            currentSchemaForDetails = schemaName; // Store schema name for sub-forms

            // Reset the object type filter to "ALL" when opening the modal
            document.getElementById('schema-object-type-filter').value = 'ALL';

            // Clear previous data for all grant types
            document.getElementById('schema-creation-date').textContent = 'Carregando...';
            document.getElementById('schema-account-status').textContent = 'Carregando...'; // Reset account status
            document.getElementById('schema-default-tablespace').textContent = 'Carregando...'; // Reset default tablespace

            // Reset forms
            document.getElementById('change-schema-password-form').reset();
            document.getElementById('change-password-schema-name').value = schemaName;
            document.getElementById('add-schema-grant-form').reset();
            document.getElementById('add-grant-schema-name').value = schemaName;
            document.getElementById('with-admin-option').checked = false;
            // Reset change default tablespace form
            document.getElementById('change-default-tablespace-form').reset();
            document.getElementById('change-default-tablespace-schema-name').value = schemaName;


            // Initial fetch for schema details, without object_type filter
            const data = await fetchData(`schema_details?name=${schemaName}`);

            if (data) {
                document.getElementById('schema-creation-date').textContent = data.creation_date || 'N/A';
                document.getElementById('schema-account-status').textContent = data.account_status || 'N/A'; // Display account status
                document.getElementById('schema-default-tablespace').textContent = data.default_tablespace || 'N/A'; // Display default tablespace

                // Populate the new default tablespace dropdown
                const newDefaultTablespaceSelect = document.getElementById('new-default-tablespace-select');
                newDefaultTablespaceSelect.innerHTML = '<option value="">Carregando...</option>';
                const tablespaces = await fetchData('tablespace_space'); // Fetch all tablespaces
                if (tablespaces) {
                    newDefaultTablespaceSelect.innerHTML = '<option value="">-- Selecione --</option>';
                    tablespaces.forEach(ts => {
                        const option = document.createElement('option');
                        option.value = ts.name;
                        option.textContent = ts.name;
                        newDefaultTablespaceSelect.appendChild(option);
                    });
                    // Set the current default tablespace as selected in the dropdown
                    if (data.default_tablespace && newDefaultTablespaceSelect.querySelector(`option[value="${data.default_tablespace}"]`)) {
                        newDefaultTablespaceSelect.value = data.default_tablespace;
                    }
                } else {
                    newDefaultTablespaceSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                }


                // Enable/disable lock/unlock buttons based on account status
                const lockButton = document.getElementById('lock-schema-button');
                const unlockButton = document.getElementById('unlock-schema-button');

                if (data.account_status === 'OPEN') {
                    lockButton.disabled = false;
                    unlockButton.disabled = true;
                } else if (data.account_status === 'LOCKED') {
                    lockButton.disabled = true;
                    unlockButton.disabled = false;
                } else {
                    // Default to both enabled if status is unknown or other
                    lockButton.disabled = false;
                    unlockButton.disabled = false;
                }

                _renderSchemaGrants(data.role_grants, data.sys_grants, data.tab_grants);
                _renderSchemaTopObjects(data.top_objects); // Render with default 'ALL' filter
                _renderSchemaObjectCounts(data.object_counts);
            } else {
                showPopupMessage('error', 'Falha ao carregar detalhes do schema.');
            }
            console.log("Frontend: Modal de detalhes do schema aberto e dados carregados.");
        }

        // Function to apply the object type filter and re-fetch schema details
        async function applySchemaObjectTypeFilter() {
            console.log("Frontend: Aplicando filtro de tipo de objeto do schema...");
            const schemaName = currentSchemaForDetails;
            const objectTypeFilter = document.getElementById('schema-object-type-filter').value;

            const params = { name: schemaName, object_type: objectTypeFilter };
            const data = await fetchData(`schema_details`, params);

            if (data) {
                _renderSchemaTopObjects(data.top_objects); // Correctly call the global function with the fetched data
            } else {
                showPopupMessage('error', 'Falha ao carregar top objetos com o filtro aplicado.');
            }
            console.log("Frontend: Filtro de tipo de objeto do schema aplicado.");
        }


        // Change Schema Password Form Submission
        document.getElementById('change-schema-password-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log("Frontend: Submissão do formulário Alterar Palavra-passe do Schema.");
            const schemaName = document.getElementById('change-password-schema-name').value;
            const newPassword = document.getElementById('new-schema-password').value;

            if (!newPassword) {
                showPopupMessage('error', 'Por favor, insira a nova palavra-passe.');
                console.error("Frontend: Validação do formulário falhou: nova palavra-passe vazia.");
                return;
            }

            const payload = {
                schema_name: schemaName,
                new_password: newPassword
            };

            // Primeiro, exibe o pop-up de confirmação genérico
            console.log("Frontend: Chamando openConfirmationModal para alterar senha do schema.");
            openConfirmationModal(`Tem certeza que deseja alterar a palavra-passe do usuário '${schemaName}'?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para alterar senha. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitChangeSchemaPasswordActual, [payload]);
            });
        });

        async function submitChangeSchemaPasswordActual(payload, adminPassword) {
            console.log("Frontend: Submetendo alteração de senha do schema...");
            payload.admin_password = adminPassword; // Add admin password to the payload
            const result = await postData('change_schema_password', payload, 'Palavra-passe alterada com sucesso!'); // postData já exibe o pop-up de sucesso/erro
            if (result) {
                // No need to re-fetch/re-render anything as password change doesn't alter visible schema details
                document.getElementById('new-schema-password').value = ''; // Clear password field
                // Após a ação bem-sucedida, atualize o log de alterações
                await updateSchemaChangeLog(payload.schema_name);
                console.log("Frontend: Alteração de senha do schema concluída com sucesso.");
            } else {
                console.error("Frontend: Falha na alteração de senha do schema.");
            }
        }

        // Change Default Tablespace Form Submission
        document.getElementById('change-default-tablespace-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log("Frontend: Submissão do formulário Alterar Tablespace Padrão do Schema.");
            const schemaName = document.getElementById('change-default-tablespace-schema-name').value;
            const newDefaultTablespace = document.getElementById('new-default-tablespace-select').value;

            if (!newDefaultTablespace) {
                showPopupMessage('error', 'Por favor, selecione um novo tablespace padrão.');
                console.error("Frontend: Validação do formulário falhou: novo tablespace padrão não selecionado.");
                return;
            }

            const payload = {
                schema_name: schemaName,
                new_default_tablespace: newDefaultTablespace
            };

            // Primeiro, exibe o pop-up de confirmação genérico
            console.log("Frontend: Chamando openConfirmationModal para alterar tablespace padrão.");
            openConfirmationModal(`Tem certeza que deseja alterar o tablespace padrão do usuário '${schemaName}' para '${newDefaultTablespace}'?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para alterar tablespace padrão. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitChangeDefaultTablespaceActual, [payload]);
            });
        });

        async function submitChangeDefaultTablespaceActual(payload, adminPassword) {
            console.log("Frontend: Submetendo alteração de tablespace padrão...");
            payload.admin_password = adminPassword; // Add admin password to the payload
            const result = await postData('change_default_tablespace', payload, 'Tablespace padrão alterado com sucesso!');
            if (result) {
                // Re-fetch schema details to update the displayed default tablespace
                const updatedData = await fetchData(`schema_details?name=${payload.schema_name}`);
                if (updatedData) {
                    document.getElementById('schema-default-tablespace').textContent = updatedData.default_tablespace || 'N/A';
                }
                document.getElementById('change-default-tablespace-form').reset(); // Reset the form
                // Após a ação bem-sucedida, atualize o log de alterações
                await updateSchemaChangeLog(payload.schema_name);
                console.log("Frontend: Alteração de tablespace padrão concluída com sucesso.");
            } else {
                console.error("Frontend: Falha na alteração de tablespace padrão.");
            }
        }


        // --- User Management Functions ---

        // Drop User
        function confirmDropSchema(schemaName) {
            console.log(`Frontend: Chamando confirmDropSchema para: ${schemaName}`);
            // Primeiro, exibe o pop-up de confirmação genérico
            openConfirmationModal(`Tem certeza que deseja dropar o usuário '${schemaName}'? Esta ação é irreversível e pode levar tempo.`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para dropar usuário. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitDropSchemaActual, [schemaName]);
            });
        }

        async function submitDropSchemaActual(schemaName, adminPassword) {
            console.log(`Frontend: Submetendo drop de schema para: ${schemaName}`);
            const payload = { schema_name: schemaName, admin_password: adminPassword };

            // Close the schema details modal immediately
            closeModal('schema-details-modal');

            // Find the schema row in the main table and update its status
            const schemaRow = document.querySelector(`#schema-table tbody tr[data-schema-name="${schemaName}"]`);
            if (schemaRow) {
                const statusCell = schemaRow.children[2]; // Assuming status is the 3rd column (index 2)
                statusCell.textContent = 'DROPPING...';
                schemaRow.classList.remove('status-open', 'status-locked', 'status-expired', 'status-expired-grace', 'status-unknown', 'status-normal', 'status-warning', 'status-critical', 'status-backup-em-andamento'); // Remove existing status classes
                schemaRow.classList.add('status-dropping'); // Add new dropping status class
                
                // Disable action button for this row during drop operation
                const actionButton = schemaRow.querySelector('.table-action-button');
                if (actionButton) {
                    actionButton.disabled = true;
                }

                // Add to droppingSchemas tracking
                droppingSchemas[schemaName] = {
                    rowElement: schemaRow,
                    displayStatus: 'DROPPING...',
                    pollingInterval: setInterval(() => pollSchemaDropStatus(schemaName, schemaRow), POLLING_INTERVAL_MS)
                };
                console.log(`Frontend: Iniciado polling para o schema '${schemaName}'.`);
            } else {
                console.warn(`Frontend: Linha para o schema '${schemaName}' não encontrada na tabela.`);
            }

            const result = await postData('drop_schema', payload, `Operação de exclusão para o schema '${schemaName}' iniciada.`); // postData já exibe o pop-up de sucesso/erro
            
            // The actual handling of success/failure will now be done by the polling mechanism
            // If the initial POST fails (e.g., network error, backend validation before async op),
            // we should revert the UI status and clear polling.
            if (!result) {
                if (droppingSchemas[schemaName]) {
                    clearInterval(droppingSchemas[schemaName].pollingInterval);
                    delete droppingSchemas[schemaName];
                }
                if (schemaRow) {
                    // Revert status to an error state or re-fetch to get actual status
                    statusCell.textContent = 'DROP FAILED (Network/Initial Error)';
                    schemaRow.classList.remove('status-dropping');
                    schemaRow.classList.add('status-critical'); // Indicate critical error
                    const actionButton = schemaRow.querySelector('.table-action-button');
                    if (actionButton) {
                        actionButton.disabled = false; // Re-enable if it was a client-side error
                    }
                }
                // Re-fetch all schemas to ensure UI is consistent with backend if initial POST failed
                schemaData = await fetchData('all_schemas');
                renderSchemaData(schemaData);
            }
            console.log(`Frontend: Requisição de drop para ${schemaName} enviada.`);
        }

        async function pollSchemaDropStatus(schemaName, schemaRow) {
            console.log(`Frontend: Verificando status do drop para: ${schemaName}`);
            const statusCell = schemaRow.children[2]; // Assuming status is the 3rd column (index 2)
            const actionButton = schemaRow.querySelector('.table-action-button');

            const statusData = await fetchData(`schema_drop_status?schema_name=${schemaName}`);
            if (statusData) {
                if (statusData.status === 'COMPLETED') {
                    clearInterval(droppingSchemas[schemaName].pollingInterval);
                    delete droppingSchemas[schemaName];
                    showPopupMessage('success', `Schema '${schemaName}' dropado com sucesso!`);
                    // Remove the row from the UI
                    schemaRow.remove();
                    // Re-fetch all schemas to ensure data consistency
                    schemaData = await fetchData('all_schemas');
                    renderSchemaData(schemaData);
                    console.log(`Frontend: Drop de schema '${schemaName}' concluído.`);
                } else if (statusData.status === 'FAILED') {
                    clearInterval(droppingSchemas[schemaName].pollingInterval);
                    delete droppingSchemas[schemaName];
                    showPopupMessage('error', `Falha ao dropar schema '${schemaName}': ${statusData.message}`);
                    statusCell.textContent = `DROP FAILED: ${statusData.message}`;
                    schemaRow.classList.remove('status-dropping');
                    schemaRow.classList.add('status-critical');
                    if (actionButton) {
                        actionButton.disabled = false; // Re-enable action button
                    }
                    // Re-fetch all schemas to ensure data consistency
                    schemaData = await fetchData('all_schemas');
                    renderSchemaData(schemaData);
                    console.error(`Frontend: Drop de schema '${schemaName}' falhou: ${statusData.message}`);
                } else if (statusData.status === 'IN_PROGRESS') {
                    statusCell.textContent = `DROPPING... (${statusData.message})`; // Update with more detailed message if available
                    console.log(`Frontend: Drop de schema '${schemaName}' em progresso: ${statusData.message}`);
                    // Keep the status-dropping class
                } else if (statusData.status === 'NOT_FOUND') {
                    // If backend says NOT_FOUND, it means the operation is no longer tracked (e.g., completed and cleaned up)
                    clearInterval(droppingSchemas[schemaName].pollingInterval);
                    delete droppingSchemas[schemaName];
                    // Re-fetch all schemas to get the latest state (schema might be gone or reverted)
                    schemaData = await fetchData('all_schemas');
                    renderSchemaData(schemaData);
                    console.warn(`Frontend: Status de drop para '${schemaName}' não encontrado no backend (pode ter sido concluído/limpo).`);
                }
            } else {
                // If fetching status fails, assume a network issue or backend problem
                clearInterval(droppingSchemas[schemaName].pollingInterval);
                delete droppingSchemas[schemaName];
                showPopupMessage('error', `Erro ao verificar status do drop para '${schemaName}'.`);
                statusCell.textContent = 'STATUS UNKNOWN (Error)';
                schemaRow.classList.remove('status-dropping');
                schemaRow.classList.add('status-unknown');
                if (actionButton) {
                    actionButton.disabled = false; // Re-enable action button
                }
                // Re-fetch all schemas to attempt to recover UI state
                schemaData = await fetchData('all_schemas');
                renderSchemaData(schemaData);
                console.error(`Frontend: Falha na requisição de status do drop para '${schemaName}'.`);
            }
        }


        // Lock User
        function confirmLockSchema(schemaName) {
            console.log(`Frontend: Chamando confirmLockSchema para: ${schemaName}`);
            // Primeiro, exibe o pop-up de confirmação genérico
            openConfirmationModal(`Tem certeza que deseja bloquear o usuário '${schemaName}'?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para bloquear usuário. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitLockSchemaActual, [schemaName]);
            });
        }

        async function submitLockSchemaActual(schemaName, adminPassword) {
            console.log(`Frontend: Submetendo bloqueio de schema para: ${schemaName}`);
            const payload = { schema_name: schemaName, admin_password: adminPassword };
            const result = await postData('lock_schema', payload, `Usuário ${schemaName} bloqueado com sucesso!`); // postData já exibe o pop-up de sucesso/erro
            if (result) {
                // Refresh schema details to show account status
                await openSchemaDetailsModal(schemaName); // Re-open to refresh status and buttons
                // Após a ação bem-sucedida, atualize o log de alterações
                await updateSchemaChangeLog(schemaName);
                // Also refresh the main schema table to reflect the status change
                schemaData = await fetchData('all_schemas');
                renderSchemaData(schemaData);
                console.log(`Frontend: Bloqueio de schema '${schemaName}' concluído com sucesso.`);
            } else {
                console.error(`Frontend: Falha no bloqueio de schema '${schemaName}'.`);
            }
        }

        // Unlock User
        function confirmUnlockSchema(schemaName) {
            console.log(`Frontend: Chamando confirmUnlockSchema para: ${schemaName}`);
            // Primeiro, exibe o pop-up de confirmação genérico
            openConfirmationModal(`Tem certeza que deseja desbloquear o usuário '${schemaName}'?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para desbloquear usuário. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitUnlockSchemaActual, [schemaName]);
            });
        }

        async function submitUnlockSchemaActual(schemaName, adminPassword) {
            console.log(`Frontend: Submetendo desbloqueio de schema para: ${schemaName}`);
            const payload = { schema_name: schemaName, admin_password: adminPassword };
            const result = await postData('unlock_schema', payload, `Usuário ${schemaName} desbloqueado com sucesso!`); // postData já exibe o pop-up de sucesso/erro
            if (result) {
                // Refresh schema details to show account status
                await openSchemaDetailsModal(schemaName); // Re-open to refresh status and buttons
                // Após a ação bem-sucedida, atualize o log de alterações
                await updateSchemaChangeLog(schemaName);
                // Also refresh the main schema table to reflect the status change
                schemaData = await fetchData('all_schemas');
                renderSchemaData(schemaData);
                console.log(`Frontend: Desbloqueio de schema '${schemaName}' concluído com sucesso.`);
            } else {
                console.error(`Frontend: Falha no desbloqueio de schema '${schemaName}'.`);
            }
        }

        // Add Schema Grant Form Submission
        document.getElementById('add-schema-grant-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log("Frontend: Submissão do formulário Adicionar Grant ao Schema.");
            const schemaName = document.getElementById('add-grant-schema-name').value;
            const grantName = document.getElementById('new-grant-name').value.trim();
            const withAdminOption = document.getElementById('with-admin-option').checked;

            if (!grantName) {
                showPopupMessage('error', 'Por favor, insira o nome do Grant.');
                console.error("Frontend: Validação do formulário falhou: nome do grant vazio.");
                return;
            }

            const payload = {
                schema_name: schemaName,
                grant_name: grantName,
                with_admin_option: withAdminOption
            };

            // Primeiro, exibe o pop-up de confirmação genérico
            console.log("Frontend: Chamando openConfirmationModal para adicionar grant.");
            openConfirmationModal(`Tem certeza que deseja adicionar o grant '${grantName}' ao usuário '${schemaName}'?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para adicionar grant. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitAddSchemaGrantActual, [payload]);
            });
        });

        async function submitAddSchemaGrantActual(payload, adminPassword) {
            console.log("Frontend: Submetendo adição de grant ao schema...");
            payload.admin_password = adminPassword; // Add admin password to the payload
            const result = await postData('add_schema_grant', payload, 'Grant adicionado com sucesso!'); // postData já exibe o pop-up de sucesso/erro
            if (result) {
                // Re-fetch schema details to update grants
                const updatedData = await fetchData(`schema_details?name=${payload.schema_name}`);
                if (updatedData) {
                    _renderSchemaGrants(updatedData.role_grants, updatedData.sys_grants, updatedData.tab_grants); // Call internal rendering functions
                }
                document.getElementById('add-schema-grant-form').reset(); // Reset the form after successful submission
                document.getElementById('with-admin-option').checked = false; // Uncheck admin option
                // Após a ação bem-sucedida, atualize o log de alterações
                await updateSchemaChangeLog(payload.schema_name);
                console.log("Frontend: Adição de grant ao schema concluída com sucesso.");
            } else {
                console.error("Frontend: Falha na adição de grant ao schema.");
            }
        }

        // Schema History Modal
        async function openSchemaHistoryModal(schemaName) {
            console.log(`Frontend: Abrindo modal de histórico do schema para: ${schemaName}`);
            openModal('schema-history-modal');
            document.getElementById('schema-history-title').textContent = `Histórico do Schema: ${schemaName}`;

            // Reset date filters for schema history and log
            document.getElementById('schema-history-start-date').value = '';
            document.getElementById('schema-history-end-date').value = '';
            document.getElementById('schema-log-start-date').value = '';
            document.getElementById('schema-log-end-date').value = '';

            // Reset chart type to default (line)
            document.getElementById('schema-history-chart-type').value = 'line';

            // Clear previous chart and log
            if (schemaHistoryChartInstance) {
                schemaHistoryChartInstance.destroy();
                schemaHistoryChartInstance = null;
            }
            document.getElementById('schema-change-log-body').innerHTML = '<li>Carregando log de alterações...</li>';

            // Load initial schema history and log without filters
            await applySchemaHistoryFilter();
            await applySchemaLogFilter();
            console.log("Frontend: Modal de histórico do schema aberto e dados carregados.");
        }

        // Apply Schema History Filter
        async function applySchemaHistoryFilter() {
            console.log("Frontend: Aplicando filtro de histórico do schema...");
            const schemaName = currentSchemaForDetails;
            const startDate = document.getElementById('schema-history-start-date').value;
            const endDate = document.getElementById('schema-history-end-date').value;
            const chartType = document.getElementById('schema-history-chart-type').value; // Get selected chart type

            const params = { name: schemaName };
            if (startDate) params.start_date = startDate + 'T00:00:00'; // Add time for full day
            if (endDate) params.end_date = endDate + 'T23:59:59'; // Add time for full day

            const historyData = await fetchData('schema_history', params);
            if (historyData) {
                renderSchemaHistoryChart(historyData, 'schema-history-chart-new', chartType); // Pass chartType
            } else {
                showPopupMessage('error', 'Falha ao carregar histórico de uso do schema.');
                const ctx = document.getElementById('schema-history-chart-new').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            }
            console.log("Frontend: Filtro de histórico do schema aplicado.");
        }

        // Apply Schema Log Filter
        async function applySchemaLogFilter() {
            console.log("Frontend: Aplicando filtro de log de alterações do schema...");
            const schemaName = currentSchemaForDetails;
            const startDate = document.getElementById('schema-log-start-date').value;
            const endDate = document.getElementById('schema-log-end-date').value;

            const params = { name: schemaName };
            if (startDate) params.start_date = startDate + 'T00:00:00'; // Add time for full day
            if (endDate) params.end_date = endDate + 'T23:59:59'; // Add time for full day

            const changeLogData = await fetchData('schema_change_log', params);
            if (changeLogData) {
                renderSchemaChangeLog(changeLogData, 'schema-change-log-body');
            } else {
                showPopupMessage('error', 'Falha ao carregar log de alterações do schema.');
                document.getElementById('schema-change-log-body').innerHTML = '<li>Nenhum log de alterações disponível.</li>';
            }
            console.log("Frontend: Filtro de log de alterações do schema aplicado.");
        }

        // Nova função para atualizar o log de alterações do schema (chamada após ações de gerenciamento)
        async function updateSchemaChangeLog(schemaName) {
            console.log(`Frontend: Atualizando log de alterações para o schema: ${schemaName}`);
            // Fetch log for the current schema without specific date filters
            const changeLogData = await fetchData(`schema_change_log?name=${schemaName}`);
            if (changeLogData) {
                renderSchemaChangeLog(changeLogData, 'schema-change-log-body');
            } else {
                showPopupMessage('error', 'Falha ao carregar log de alterações do schema.');
                document.getElementById('schema-change-log-body').innerHTML = '<li>Nenhum log de alterações disponível.</li>';
            }
            console.log("Frontend: Log de alterações do schema atualizado.");
        }

        function renderTablespaceHistoryChart(data, canvasId, chartType = 'line') { // Added chartType parameter
            console.log(`Frontend: Iniciando renderTablespaceHistoryChart para ${canvasId} com tipo ${chartType}.`);
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (tablespaceHistoryChartInstance) {
                tablespaceHistoryChartInstance.destroy();
                tablespaceHistoryChartInstance = null; // Ensure it's nullified
            }

            console.log(`Frontend: renderTablespaceHistoryChart recebido dados:`, data); // Log data received by chart function

            if (!data || data.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Arial";
                ctx.fillStyle = "#888";
                ctx.textAlign = "center";
                ctx.fillText("Nenhum dado de histórico disponível.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                console.warn("Frontend: Nenhum dado de histórico para tablespace, exibindo mensagem no canvas.");
                return;
            }

            // Prepare labels and x-axis data based on chart type
            let labelsOrXData;
            let xScaleType;

            if (chartType === 'scatter') {
                labelsOrXData = data.map(item => new Date(item.timestamp).getTime());
                xScaleType = 'time';
            } else {
                labelsOrXData = data.map(item => new Date(item.timestamp).toLocaleString());
                xScaleType = 'category';
            }

            const usedPercent = data.map(item => {
                if (chartType === 'scatter') {
                    return { x: new Date(item.timestamp).getTime(), y: item.used_percent };
                }
                return item.used_percent;
            });

            tablespaceHistoryChartInstance = new Chart(ctx, {
                type: chartType, // Use the selected chart type
                data: {
                    labels: chartType !== 'scatter' ? labelsOrXData : undefined,
                    datasets: [{
                        label: 'Uso do Tablespace (%)',
                        data: usedPercent,
                        borderColor: '#4c51bf',
                        backgroundColor: 'rgba(76, 81, 191, 0.2)',
                        fill: chartType === 'line' ? true : false,
                        tension: chartType === 'line' ? 0.1 : 0,
                        pointRadius: chartType === 'scatter' ? 5 : 3,
                        showLine: chartType !== 'bar'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: xScaleType, // Dynamic x-axis type
                            title: {
                                display: true,
                                text: 'Data/Hora'
                            },
                            ...(xScaleType === 'time' && {
                                time: {
                                    unit: 'hour', // or 'day', 'month', etc.
                                    tooltipFormat: 'DD/MM/YYYY HH:mm:ss',
                                    displayFormats: {
                                        hour: 'DD/MM/YYYY HH:mm',
                                        day: 'DD/MM/YYYY',
                                        month: 'MM/YYYY',
                                        year: 'YYYY'
                                    }
                                },
                                adapters: {
                                    date: {
                                        // This assumes you have Luxon or Moment.js loaded.
                                    }
                                }
                            })
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Uso (%)'
                            },
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            console.log(`Frontend: Gráfico de histórico do tablespace (${chartType}) renderizado com sucesso.`);
        }

        function renderSchemaHistoryChart(data, canvasId, chartType = 'line') { // Added chartType parameter
            console.log(`Frontend: Iniciando renderSchemaHistoryChart para ${canvasId} com tipo ${chartType}.`);
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (schemaHistoryChartInstance) {
                schemaHistoryChartInstance.destroy();
                schemaHistoryChartInstance = null; // Ensure it's nullified
            }

            if (!data || data.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Arial";
                ctx.fillStyle = "#888";
                ctx.textAlign = "center";
                ctx.fillText("Nenhum dado de histórico disponível.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                console.warn("Frontend: Nenhum dado de histórico para schema, exibindo mensagem no canvas.");
                return;
            }

            // Prepare labels and x-axis data based on chart type
            let labelsOrXData;
            let xScaleType;

            if (chartType === 'scatter') {
                labelsOrXData = data.map(item => new Date(item.timestamp).getTime());
                xScaleType = 'time';
            } else {
                labelsOrXData = data.map(item => new Date(item.timestamp).toLocaleString());
                xScaleType = 'category';
            }

            const usedGb = data.map(item => {
                if (chartType === 'scatter') {
                    return { x: new Date(item.timestamp).getTime(), y: item.used_gb };
                }
                return item.used_gb;
            });

            schemaHistoryChartInstance = new Chart(ctx, {
                type: chartType, // Use the selected chart type
                data: {
                    labels: chartType !== 'scatter' ? labelsOrXData : undefined,
                    datasets: [{
                        label: 'Uso do Schema (GB)',
                        data: usedGb,
                        borderColor: '#4c51bf',
                        backgroundColor: 'rgba(76, 81, 191, 0.2)',
                        fill: chartType === 'line' ? true : false,
                        tension: chartType === 'line' ? 0.1 : 0,
                        pointRadius: chartType === 'scatter' ? 5 : 3,
                        showLine: chartType !== 'bar'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Data/Hora'
                            },
                            ...(xScaleType === 'time' && {
                                time: {
                                    unit: 'hour', // or 'day', 'month', etc.
                                    tooltipFormat: 'DD/MM/YYYY HH:mm:ss',
                                    displayFormats: {
                                        hour: 'DD/MM/YYYY HH:mm',
                                        day: 'DD/MM/YYYY',
                                        month: 'MM/YYYY',
                                        year: 'YYYY'
                                    }
                                },
                                adapters: {
                                    date: {
                                        // This assumes you have Luxon or Moment.js loaded.
                                    }
                                }
                            })
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Uso (GB)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            console.log(`Frontend: Gráfico de histórico do schema (${chartType}) renderizado com sucesso.`);
        }

        function renderSchemaChangeLog(data, listId) {
            console.log("Frontend: Iniciando renderSchemaChangeLog...");
            const ul = document.getElementById(listId);
            ul.innerHTML = '';
            if (!data || data.length === 0) {
                ul.innerHTML = '<li>Nenhum log de alterações disponível.</li>';
                console.warn("Frontend: Nenhum log de alterações disponível, exibindo mensagem.");
                return;
            }
            data.forEach(log => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${new Date(log.timestamp).toLocaleString()}</strong> - [${log.change_type}] ${log.description} (Por: ${log.changed_by})`;
                ul.appendChild(li);
            });
            console.log("Frontend: Log de alterações do schema renderizado.");
        }

        // Function to display the admin password prompt modal
        // Now accepts a callback function and its arguments
        function showAdminPasswordPrompt(callbackFunction, callbackArgs) {
            console.log("Frontend: Exibindo prompt de senha administrativa.");
            document.getElementById('admin-password-input').value = ''; // Clear previous password
            nextAdminAction = { func: callbackFunction, args: callbackArgs }; // Store the action to be performed
            openModal('admin-password-prompt-modal');
        }

        // Function to display the generic confirmation modal
        function openConfirmationModal(message, onConfirmCallback) {
            console.log("Frontend: Exibindo modal de confirmação.");
            document.getElementById('confirmation-title').textContent = "Confirmação"; // Ensure title is always "Confirmação"
            document.getElementById('confirmation-message').textContent = message;
            nextConfirmationAction = onConfirmCallback; // Store the callback for when "Confirmar" is clicked
            openModal('confirmation-modal');
        }

        // Event listener for the "Confirmar" button in the generic confirmation modal
        document.getElementById('confirm-action-button').onclick = function() {
            console.log("Frontend: Botão 'Confirmar' do modal de confirmação clicado.");
            closeModal('confirmation-modal'); // Close the confirmation modal
            if (nextConfirmationAction) {
                console.log("Frontend: Executando nextConfirmationAction.");
                nextAdminAction = null; // Clear the stored action
                nextConfirmationAction(); // Execute the stored callback (which will typically open the admin password modal or execute the action directly)
            }
        };


        // Create User Modal (initial button click handler)
        async function openCreateUserModal() {
            console.log("Frontend: Chamando openConfirmationModal para criar novo usuário.");
            // Primeiro, exibe o pop-up de confirmação genérico (opcional, mas boa prática para criação de usuário)
            openConfirmationModal(`Tem certeza que deseja criar um novo usuário Oracle?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para criar usuário. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(openCreateUserModalContent, []);
            });
        }

        // This function will actually open and populate the create user modal
        async function openCreateUserModalContent() {
            console.log("Frontend: Abrindo modal de criação de usuário.");
            openModal('create-user-modal'); // Open the actual create user modal
            document.getElementById('create-user-form').reset();
            document.getElementById('grant-dba').checked = false;
            document.getElementById('grant-create-session').checked = true; // Default to true

            // Populate tablespace dropdowns
            const defaultTablespaceSelect = document.getElementById('default-tablespace');
            const temporaryTablespaceSelect = document.getElementById('temporary-tablespace');

            defaultTablespaceSelect.innerHTML = '<option value="">Carregando...</option>';
            temporaryTablespaceSelect.innerHTML = '<option value="">Opcional: Carregando...</option>';

            const tablespaces = await fetchData('tablespace_space');
            if (tablespaces) {
                defaultTablespaceSelect.innerHTML = '<option value="">-- Selecione --</option>';
                tablespaces.forEach(ts => {
                    const option1 = document.createElement('option');
                    option1.value = ts.name;
                    option1.textContent = ts.name;
                    defaultTablespaceSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = ts.name;
                    option2.textContent = ts.name;
                    temporaryTablespaceSelect.appendChild(option2);
                });
            } else {
                defaultTablespaceSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                temporaryTablespaceSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
            console.log("Frontend: Modal de criação de usuário aberto e campos populados.");
        }


        document.getElementById('create-user-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log("Frontend: Submissão do formulário Criar Utilizador.");
            const form = event.target;
            const username = form['username'].value.trim();
            const password = form['password'].value;
            const defaultTablespace = form['default_tablespace'].value;
            const temporaryTablespace = form['temporary_tablespace'].value || null;
            const grantDba = form['grant_dba'].checked;
            const grantCreateSession = form['grant_create_session'].checked;

            if (!username || !password || !defaultTablespace) {
                showPopupMessage('error', 'Por favor, preencha todos os campos obrigatórios.');
                console.error("Frontend: Validação do formulário falhou: campos obrigatórios vazios.");
                return;
            }
            if (!grantCreateSession && !grantDba) {
                showPopupMessage('error', 'O utilizador deve ter pelo menos o privilégio CREATE SESSION ou DBA.');
                console.error("Frontend: Validação do formulário falhou: privilégio CREATE SESSION ou DBA não concedido.");
                return;
            }

            const payload = {
                username: username,
                password: password,
                default_tablespace: defaultTablespace,
                temporary_tablespace: temporaryTablespace,
                grant_dba: grantDba,
                grant_create_session: grantCreateSession
            };

            // A confirmação para criar usuário já é feita no openCreateUserModal, então aqui vai direto para a senha admin
            console.log("Frontend: Chamando showAdminPasswordPrompt para submeter criação de usuário.");
            showAdminPasswordPrompt(submitCreateUserActual, [payload]);
        });

        async function submitCreateUserActual(payload, adminPassword) {
            console.log("Frontend: Submetendo criação de usuário...");
            payload.admin_password = adminPassword; // Add admin password to the payload
            const result = await postData('create_user', payload, 'Utilizador criado com sucesso!'); // postData já exibe o pop-up de sucesso/erro
            if (result) {
                closeModal('create-user-modal'); // Close the modal after successful creation
                loadDataForSelectedTNS(); // Refresh schema list
                // Após a ação bem-sucedida, atualize o log de alterações
                await updateSchemaChangeLog(payload.username); // Use username for the log
                console.log("Frontend: Criação de usuário concluída com sucesso.");
            } else {
                console.error("Frontend: Falha na criação de usuário.");
            }
        }

        // Admin Password Prompt Form Submission
        document.getElementById('admin-password-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log("Frontend: Submissão do formulário de senha administrativa.");
            const adminPassword = document.getElementById('admin-password-input').value.trim();

            if (!adminPassword) {
                showPopupMessage('error', 'Por favor, insira a senha administrativa.');
                console.error("Frontend: Senha administrativa vazia.");
                return;
            }

            const payload = { admin_password: adminPassword };
            const result = await postData('validate_admin_password', payload, 'Senha validada.'); // postData já exibe o pop-up de sucesso/erro

            if (result && result.success) {
                closeModal('admin-password-prompt-modal');
                if (nextAdminAction && nextAdminAction.func) {
                    console.log("Frontend: Senha validada. Executando ação seguinte:", nextAdminAction.func.name);
                    // Pass the adminPassword to the next action function
                    nextAdminAction.func(...nextAdminAction.args, adminPassword); 
                    nextAdminAction = null; // Clear the stored action
                }
            } else {
                // Mensagem de erro já foi exibida por postData, apenas log para consistência
                console.log("Frontend: Validação de senha admin falhou.");
            }
        });

        // Print Table Report Function
        function printTableReport(tableId, title) {
            console.log(`Frontend: Imprimindo relatório da tabela: ${tableId}`);
            const table = document.getElementById(tableId);
            if (!table) {
                showPopupMessage('error', `Tabela com ID '${tableId}' não encontrada para impressão.`);
                console.error(`Frontend: Erro: Tabela com ID '${tableId}' não encontrada para impressão.`);
                return;
            }

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            // Include basic print styles
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: "Inter", sans-serif; margin: 20px; }');
            printWindow.document.write('h1 { text-align: center; margin-bottom: 20px; color: #333; }');
            printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-top: 20px; }');
            printWindow.document.write('th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 0.9em; }');
            printWindow.document.write('th { background-color: #f2f2f2; color: #333; }');
            printWindow.document.write('.status-normal { background-color: #e6ffe6; }');
            printWindow.document.write('.status-warning { background-color: #ffeecf; }');
            printWindow.document.write('.status-critical { background-color: #ffcdd2; }');
            printWindow.document.write('.status-open { background-color: #e6ffe6; }');
            printWindow.document.write('.status-locked { background-color: #ffcdd2; }');
            printWindow.document.write('.status-expired { background-color: #ffeecf; }');
            printWindow.document.write('.status-expired-grace { background-color: #ffeecf; }');
            printWindow.document.write('.status-unknown { background-color: #e2e8f0; }');
            printWindow.document.write('.status-dropping { background-color: #e0f2fe; }'); // Add dropping status print style
            printWindow.document.write('.status-backup-em-andamento { background-color: #bfdbfe; }'); // Add backup status print style
            printWindow.document.write('.no-print { display: none !important; }'); // Hide 'Ações' column
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>' + title + '</h1>');
            printWindow.document.write('<p>Data do Relatório: ' + new Date().toLocaleString() + '</p>');
            printWindow.document.write('<p>TNS Conectado: ' + selectedTNS + '</p>');

            // Clone the table to remove the "Ações" column for printing
            const clonedTable = table.cloneNode(true);
            // Remove the "Ações" header
            const actionsHeader = clonedTable.querySelector('th.no-print');
            if (actionsHeader) {
                actionsHeader.remove();
            }
            // Remove the "Ações" cells from each row
            clonedTable.querySelectorAll('td.no-print').forEach(cell => cell.remove());

            printWindow.document.write('<div id="printable-table">');
            printWindow.document.write(clonedTable.outerHTML);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            console.log(`Frontend: Relatório da tabela '${tableId}' impresso.`);
        }

        // Function to print a chart (canvas)
        function printChart(canvasId, title) {
            console.log(`Frontend: Imprimindo gráfico: ${canvasId}`);
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                showPopupMessage('error', `Gráfico com ID '${canvasId}' não encontrado para impressão.`);
                console.error(`Frontend: Erro: Gráfico com ID '${canvasId}' não encontrado para impressão.`);
                return;
            }

            // Create a temporary image from the canvas
            const imageData = canvas.toDataURL('image/png');

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: "Inter", sans-serif; text-align: center; margin: 20px; }');
            printWindow.document.write('h1 { margin-bottom: 20px; color: #333; }');
            printWindow.document.write('img { max-width: 100%; height: auto; display: block; margin: 0 auto; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>' + title + '</h1>');
            printWindow.document.write('<img src="' + imageData + '" />');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            console.log(`Frontend: Gráfico '${canvasId}' impresso.`);
        }

        // NEW: Function to open the backup modal
        async function openBackupModal(schemaName) {
            console.log(`Frontend: Abrindo modal de backup para schema: ${schemaName}`);
            openModal('backup-modal');
            document.getElementById('backup-schema-name-display').textContent = schemaName;
            document.getElementById('backup-schema-name').value = schemaName;
            currentSchemaForBackup = schemaName;

            // Reset backup form and status display
            document.getElementById('backup-form').reset();
            document.getElementById('backup-status-area').classList.add('hidden');
            document.getElementById('backup-current-status').textContent = '';
            document.getElementById('backup-log-output').textContent = ''; // Clear previous log
            document.getElementById('start-backup-button').disabled = false; // Enable button

            // Generate default DMP and LOG file names
            const now = new Date();
            const dateTimeFormat = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
            document.getElementById('backup-dmp-file').value = `${schemaName}_${dateTimeFormat}.dmp`;
            document.getElementById('backup-log-file').value = `${schemaName}_${dateTimeFormat}.log`;

            // Populate Data Pump Directory dropdown dynamically
            const backupDirectorySelect = document.getElementById('backup-directory');
            backupDirectorySelect.innerHTML = '<option value="">Carregando diretórios...</option>';
            const directories = await fetchData('datapump_directories');
            if (directories && directories.length > 0) {
                backupDirectorySelect.innerHTML = ''; // Clear loading message
                directories.forEach(dir => {
                    const option = document.createElement('option');
                    option.value = dir;
                    option.textContent = dir;
                    backupDirectorySelect.appendChild(option);
                });
                // Set a default selected directory if one exists (e.g., 'DATA_PUMP_DIR')
                if (backupDirectorySelect.querySelector('option[value="DATA_PUMP_DIR"]')) {
                    backupDirectorySelect.value = 'DATA_PUMP_DIR';
                } else {
                    backupDirectorySelect.value = directories[0]; // Select the first available directory
                }
            } else {
                backupDirectorySelect.innerHTML = '<option value="">Nenhum diretório encontrado</option>';
                showPopupMessage('warning', 'Nenhum diretório Datapump encontrado. Verifique a configuração do Oracle.');
            }

            // Check if there's an ongoing backup and update UI accordingly
            const status = await fetchData(`backup_status/${schemaName}`);
            if (status && status.status !== "nenhum backup") {
                document.getElementById('backup-status-area').classList.remove('hidden');
                document.getElementById('backup-current-status').textContent = status.status;
                document.getElementById('backup-log-output').textContent = status.log_output.join('\n'); // Display log output
                if (status.status === "backup em andamento" || status.status === "iniciando backup") {
                    document.getElementById('start-backup-button').disabled = true; // Disable start button if in progress
                    // Start polling if not already
                    if (!backupPollingInterval) {
                        backupPollingInterval = setInterval(() => pollBackupStatus(schemaName), POLLING_INTERVAL_MS);
                    }
                } else {
                    document.getElementById('start-backup-button').disabled = false; // Enable if completed/failed
                }
            } else {
                // Ensure polling is stopped if no backup is found
                if (backupPollingInterval) {
                    clearInterval(backupPollingInterval);
                    backupPollingInterval = null;
                }
            }
            console.log("Frontend: Modal de backup aberto e campos populados.");
        }

        // NEW: Handle backup form submission
        document.getElementById('backup-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log("Frontend: Submissão do formulário de backup.");

            const schemaName = document.getElementById('backup-schema-name').value;
            const directory = document.getElementById('backup-directory').value;
            const dmpFile = document.getElementById('backup-dmp-file').value;
            const logFile = document.getElementById('backup-log-file').value;

            if (!directory || !dmpFile || !logFile) {
                showPopupMessage('error', 'Por favor, preencha todos os campos do backup.');
                console.error("Frontend: Validação do formulário de backup falhou: campos vazios.");
                return;
            }

            const payload = {
                schema_name: schemaName,
                directory: directory,
                dmp_file: dmpFile,
                log_file: logFile,
                tns_alias: selectedTNS // Ensure tns_alias is sent with the payload
            };

            // Primeiro, exibe o pop-up de confirmação genérico
            console.log("Frontend: Chamando openConfirmationModal para iniciar backup.");
            openConfirmationModal(`Tem certeza que deseja iniciar o backup Datapump para o schema '${schemaName}'?`, () => {
                // Se o utilizador confirmar, então exibe o pop-up de senha administrativa
                console.log("Frontend: Confirmação recebida para iniciar backup. Chamando showAdminPasswordPrompt.");
                showAdminPasswordPrompt(submitBackupActual, [payload]);
            });
        });

        // NEW: Function to submit backup request
        async function submitBackupActual(payload, adminPassword) {
            console.log("Frontend: Submetendo requisição de backup...");
            payload.admin_password = adminPassword; // Add admin password to the payload

            document.getElementById('start-backup-button').disabled = true; // Disable button immediately
            document.getElementById('backup-status-area').classList.remove('hidden');
            document.getElementById('backup-current-status').textContent = 'Iniciando backup...';
            document.getElementById('backup-log-output').textContent = 'Iniciando operação de backup...'; // Initial log message

            const result = await postData('initiate_backup', payload, `Backup para ${payload.schema_name} iniciado!`);
            if (result && result.success) {
                // Update main schema table status
                const schemaRow = document.querySelector(`#schema-table tbody tr[data-schema-name="${payload.schema_name}"]`);
                if (schemaRow) {
                    schemaRow.classList.remove('status-open', 'status-locked', 'status-expired', 'status-expired-grace', 'status-unknown', 'status-normal', 'status-warning', 'status-critical', 'status-dropping');
                    schemaRow.classList.add('status-backup-em-andamento');
                    const statusCell = schemaRow.children[2];
                    statusCell.textContent = 'backup em andamento';
                }
                // Start polling for status updates
                if (backupPollingInterval) {
                    clearInterval(backupPollingInterval); // Clear any existing interval
                }
                backupPollingInterval = setInterval(() => pollBackupStatus(payload.schema_name), POLLING_INTERVAL_MS);
                console.log("Frontend: Polling de status de backup iniciado.");
            } else {
                document.getElementById('start-backup-button').disabled = false; // Re-enable button on failure
                document.getElementById('backup-current-status').textContent = 'Falha ao iniciar backup.';
                document.getElementById('backup-log-output').textContent = `Falha ao iniciar backup: ${result ? result.message : 'Erro de rede ou servidor'}`; // Update log with failure
                if (backupPollingInterval) {
                    clearInterval(backupPollingInterval);
                    backupPollingInterval = null;
                }
                // Re-fetch all schemas to revert status if initial POST failed
                schemaData = await fetchData('all_schemas');
                renderSchemaData(schemaData);
                console.error("Frontend: Falha ao iniciar backup.");
            }
        }

        // NEW: Function to poll backup status
        async function pollBackupStatus(schemaName) {
            console.log(`Frontend: Verificando status do backup para: ${schemaName}`);
            const status = await fetchData(`backup_status/${schemaName}`);
            if (status) {
                document.getElementById('backup-current-status').textContent = status.status;
                document.getElementById('backup-log-output').textContent = status.log_output.join('\n'); // Display log output
                // Scroll log to bottom
                const logOutputElement = document.getElementById('backup-log-output');
                logOutputElement.scrollTop = logOutputElement.scrollHeight;


                if (status.status === 'concluído' || status.status === 'falhou' || status.status === 'nenhum backup') {
                    clearInterval(backupPollingInterval);
                    backupPollingInterval = null;
                    document.getElementById('start-backup-button').disabled = false; // Re-enable button
                    showPopupMessage(status.status === 'concluído' ? 'success' : 'error', `Backup para ${schemaName} ${status.status}!`);
                    // Refresh main schema table to reflect final status
                    schemaData = await fetchData('all_schemas');
                    renderSchemaData(schemaData);
                    console.log(`Frontend: Polling de backup para '${schemaName}' encerrado. Status: ${status.status}`);
                    // After backup completes, refresh the schema change log
                    await updateSchemaChangeLog(schemaName);
                }
            } else {
                // If fetch fails, stop polling and show error
                clearInterval(backupPollingInterval);
                backupPollingInterval = null;
                document.getElementById('start-backup-button').disabled = false;
                showPopupMessage('error', `Erro ao obter status do backup para ${schemaName}.`);
                document.getElementById('backup-current-status').textContent = 'Erro ao verificar status';
                document.getElementById('backup-log-output').textContent = 'Erro ao carregar log de status.'; // Update log with error
                // Re-fetch all schemas to attempt to recover UI state
                schemaData = await fetchData('all_schemas');
                renderSchemaData(schemaData);
                console.error(`Frontend: Falha na requisição de status do backup para '${schemaName}'.`);
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Frontend: DOMContentLoaded disparado. Iniciando configurações iniciais.");
            // Move fetchCombinedHistoryData and renderCombinedHistoryChart definitions here
            // to ensure they are available before loadDataForSelectedTNS is called.

            // Initialize interact.js for draggable and resizable cards
            interact('.card')
                .draggable({
                    inertia: true,
                    // Ignore dragging from select elements within the card
                    ignoreFrom: 'select', 
                    modifiers: [
                        interact.modifiers.restrictRect({
                            restriction: '#main-content-wrapper', // Restrict dragging within the main content wrapper
                            endOnly: true
                        }),
                        interact.modifiers.snap({
                            targets: [
                                interact.snappers.grid({ x: 20, y: 20 }) // Snap to a 20x20 grid
                            ],
                            range: Infinity,
                            relativePoints: [{ x: 0, y: 0 }]
                        })
                    ],
                    autoScroll: true,
                    onstart: function (event) {
                        // Bring the dragged element to the front
                        event.target.style.zIndex = 100;
                    },
                    onmove: dragMoveListener,
                    onend: function (event) {
                        // Reset z-index after dragging
                        event.target.style.zIndex = '';
                        // Optionally save position here if persistence is desired
                        // console.log('Element moved to:', event.target.dataset.x, event.target.dataset.y);
                    }
                })
                .resizable({
                    // Resize from all edges and corners
                    edges: { left: true, right: true, bottom: true, top: true },

                    listeners: {
                        move (event) {
                            let target = event.target;
                            let x = (parseFloat(target.getAttribute('data-x')) || 0);
                            let y = (parseFloat(target.getAttribute('data-y')) || 0);

                            // Update the element's width and height
                            target.style.width = event.rect.width + 'px';
                            target.style.height = event.rect.height + 'px';

                            // Translate when resizing from top or left edges
                            x += event.deltaRect.left;
                            y += event.deltaRect.top;

                            target.style.transform = `translate(${x}px, ${y}px)`;

                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                            // Optionally save size here if persistence is desired
                            // console.log('Element resized to:', event.rect.width, event.rect.height);
                        },
                        end (event) {
                            // Optionally save size here if persistence is desired
                            // console.log('Element finished resizing to:', event.rect.width, event.rect.height);
                        }
                    },
                    modifiers: [
                        // Keep the element within the parent
                        interact.modifiers.restrictEdges({
                            outer: '#main-content-wrapper',
                            endOnly: true,
                        }),

                        // Minimum size
                        interact.modifiers.restrictSize({
                            min: { width: 200, height: 100 },
                        }),
                        interact.modifiers.snap({ // Apply snap to resizing as well
                            targets: [
                                interact.snappers.grid({ x: 20, y: 20 })
                            ],
                            range: Infinity,
                            relativePoints: [{ x: 0, y: 0 }]
                        })
                    ],
                });

            function dragMoveListener (event) {
                let target = event.target;
                // Keep the dragged position in the data-x/data-y attributes
                let x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                // Translate the element
                target.style.transform = `translate(${x}px, ${y}px)`;

                // Update the position attributes
                target.setAttribute('data-x', x);
                target.setAttribute('data-y', y);
            }

            // This is used later to register the listener
            window.dragMoveListener = dragMoveListener;

            try {
                await fetchTnsList(); // Load TNS list first
                await fetchAppVersion(); // Fetch and display app version
                await loadDataForSelectedTNS(); // Load initial data for the first TNS
            } catch (error) {
                console.error("Frontend: Erro fatal durante o carregamento inicial de dados:", error);
                showGlobalMessage('error', `Erro fatal na inicialização: ${error.message}. Verifique o console para mais detalhes.`);
            }

            // Add event listener for TNS selector change
            document.getElementById('tns-select').addEventListener('change', loadDataForSelectedTNS);

            // Add event listener for schema search
            document.getElementById('schema-search').addEventListener('keyup', () => renderSchemaData(schemaData));

            // Add event listener for new datafile autoextend checkbox
            const newDatafileAutoextendCheckbox = document.getElementById('new-datafile-autoextend');
            const autoextendOptionsDiv = document.getElementById('autoextend-options');

            if (newDatafileAutoextendCheckbox && autoextendOptionsDiv) {
                newDatafileAutoextendCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        autoextendOptionsDiv.classList.remove('hidden');
                    } else {
                        autoextendOptionsDiv.classList.add('hidden');
                    }
                });
            }

            // Add event listener for schema object type filter
            document.getElementById('schema-object-type-filter').addEventListener('change', applySchemaObjectTypeFilter);

            // NEW: Add event listener for combined history filter button
            document.getElementById('combined-history-filter-button').addEventListener('click', fetchCombinedHistoryData);
            // NEW: Add event listener for combined history chart type selector
            document.getElementById('combined-history-chart-type').addEventListener('change', fetchCombinedHistoryData);
            // NEW: Add event listener for combined history view filter selector
            document.getElementById('combined-history-view-filter').addEventListener('change', fetchCombinedHistoryData); // NEW

            // NEW: Add event listener for tablespace history chart type selector
            document.getElementById('tablespace-history-chart-type').addEventListener('change', applyTablespaceHistoryFilter); // NEW
            // NEW: Add event listener for schema history chart type selector
            document.getElementById('schema-history-chart-type').addEventListener('change', applySchemaHistoryFilter);
            console.log("Frontend: Configuração inicial de event listeners concluída.");
        });

        // Global click handler for closing modals by clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target == modal) {
                    closeModal(modal.id);
                }
            });
        }

        // Helper function to escape strings for JavaScript string literals within HTML attributes
        // This function is crucial for preventing SyntaxErrors when passing strings with special characters
        // to JavaScript functions via onclick attributes.
        function escapeJsStringLiteral(str) {
            // JSON.stringify handles all necessary escaping (quotes, backslashes, newlines, etc.)
            // and wraps the string in double quotes.
            return JSON.stringify(str);
        }
    </script>
</body>
</html>
